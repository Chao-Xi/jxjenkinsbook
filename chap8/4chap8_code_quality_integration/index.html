
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Jacob's 手摸手Jenkins实用教程">
      
      
        <meta name="author" content="Jacob Xi">
      
      
      
        <link rel="prev" href="../3chap8_code_quality_allure/">
      
      
        <link rel="next" href="../../chap9/chap9_artifact0/">
      
      <link rel="icon" href="../../images/logo.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.17">
    
    
      
        <title>第四季 代码质量平台集成(SonarQube Final Edition) - Jacob Jenkins Books</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.26e3688c.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="deep-purple">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#sonarqube-final-edition" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="Jacob Jenkins Books" class="md-header__button md-logo" aria-label="Jacob Jenkins Books" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Jacob Jenkins Books
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              第四季 代码质量平台集成(SonarQube Final Edition)
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Chao-Xi/jxjenkinsbook.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxjenkinsbook
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Jacob Jenkins Books" class="md-nav__button md-logo" aria-label="Jacob Jenkins Books" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    Jacob Jenkins Books
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Chao-Xi/jxjenkinsbook.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxjenkinsbook
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Welcome
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          一、Jenkins 运维管理
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          一、Jenkins 运维管理
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../jk_chapter1/" class="md-nav__link">
        第一节 Jenkins 运维管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../jk_chapter1_2/" class="md-nav__link">
        第二节 分布式构建与并行构建
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../jk_chapter1_3/" class="md-nav__link">
        第三节 可视化构建试图
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/1active_parameter/" class="md-nav__link">
        第四节 使用Active Choice Parameter参数化构建
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/2python-jenkins/" class="md-nav__link">
        第五节 自动化使用python-jenkins管理Jenkins
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          二、Jenkins 流水线基础
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          二、Jenkins 流水线基础
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/1chap2_Jenkinsfile/" class="md-nav__link">
        第一节 编写 Jenkinsfile 运行流水线
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/2chap2_declarative_pipeline/" class="md-nav__link">
        第二节 声明式流水线语法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/3chap2_script_pipeline/" class="md-nav__link">
        第三节 脚本化Pipeline
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/4chap2_sharedlib/" class="md-nav__link">
        第四节 Pipeline 扩展——共享库
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/5chap2_quick_jenkinsfile/" class="md-nav__link">
        第五节 如何快速上手Jenkinsfile编写
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/6chap2_pipe_vs_dec/" class="md-nav__link">
        第六节 脚本式管道与声明式管道-四个实际差异
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/7chap2_jenkins_git/" class="md-nav__link">
        第七节 使用Jenkins Git参数实现分支标签动态选择
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/8Jenkinsfile_pipeline_multibranch/" class="md-nav__link">
        第八节 多分支类型管道- 基于Jenkinsfile自动创建Pipeline(2023)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/9jenkins_parallel2023/" class="md-nav__link">
        第九节 实践-Jenkins 声明式管道中的动态并行阶段
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/10mc_parallel/" class="md-nav__link">
        第十节 微服务模式下如何实现多模块并行构建发布
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          三、Groovy 基础
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          三、Groovy 基础
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/1chap3_groovy_basic/" class="md-nav__link">
        第一节 Groovy 简明教程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/2chap3_groovy_basic2/" class="md-nav__link">
        第二节 Groovy 基础
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          四、构建工具集成
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          四、构建工具集成
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/1chp4_tools1/" class="md-nav__link">
        第一节 构建工具集成
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/2chp4_tools2/" class="md-nav__link">
        第二节 集成 SaltStack 部署工具
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/3chp4_tools3/" class="md-nav__link">
        第三节 Jenkins集成Ansibe实现自动化部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/4chp4_tools4/" class="md-nav__link">
        第四节 Jenkins集成Ansibe实战手册 - BB Mobile（2018）
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          五、凭证管理
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          五、凭证管理
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/5jenkins_secrets/" class="md-nav__link">
        0 如何在 Jenkins 中安全管理 Secrets
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/1chap5_cred1/" class="md-nav__link">
        第一节 凭证管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/2chap5_vault/" class="md-nav__link">
        第二节 凭证管理使用HashiCorp Vault
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/3docker_valut/" class="md-nav__link">
        第二节(Extra) - Store Secrets using Hashicorp Vault with Docker
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/4docker_mask/" class="md-nav__link">
        第三节 在Jenkins日志中隐藏敏感信息
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
      
      
      
        <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
          六、用户认证集成
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          六、用户认证集成
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/1chap6_ldap/" class="md-nav__link">
        第一节 Ldap 用户认证集成
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/2chap6_gitlab/" class="md-nav__link">
        第二节 Jenkins集成 Gitlab SSO 单点登录
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/3chap6_github/" class="md-nav__link">
        第三节 Jenkins集成 Github SSO 单点登录
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
      
      
      
        <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
          七、Gitlab 版本控制系统集成
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          七、Gitlab 版本控制系统集成
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/1chap7_gitlab_connect/" class="md-nav__link">
        第一节 Gitlab – Jenkins Integration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/2chap7_gitlab_pipeline/" class="md-nav__link">
        第二节 Gitlab-Jenkins 版本控制
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/3chap7_gitlab_pipeline_extra/" class="md-nav__link">
        第三节 Gitlab-Jenkins 版本控制（补充）
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/4gitops_cicd/" class="md-nav__link">
        ​第四节 GitOps Gitlab-Jenkins 模式下微服务CI/CD实践
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" checked>
      
      
      
        <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
          八、代码质量平台集成
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          八、代码质量平台集成
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../1chap8_code_quality/" class="md-nav__link">
        第一节 代码质量
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2chap8_code_quality_sonarqube/" class="md-nav__link">
        第二节 SonarQube：持续代码质量检查
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../3chap8_code_quality_allure/" class="md-nav__link">
        第三节 Allure测试报告：更美观的测试报告
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          第四季 代码质量平台集成(SonarQube Final Edition)
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        第四季 代码质量平台集成(SonarQube Final Edition)
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-sonarqube" class="md-nav__link">
    1、 SonarQube 平台简介与配置
  </a>
  
    <nav class="md-nav" aria-label="1、 SonarQube 平台简介与配置">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-1" class="md-nav__link">
    1-1 工作流程
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-2-sonarqube" class="md-nav__link">
    1-2 SonarQube安装
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-3" class="md-nav__link">
    1-3 服务集成
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2sonarqube" class="md-nav__link">
    2、SonarQube 扫描仪配置
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3sonarqube" class="md-nav__link">
    3、SonarQube 本地使用扫描仪项目分析配置
  </a>
  
    <nav class="md-nav" aria-label="3、SonarQube 本地使用扫描仪项目分析配置">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#3-1-maven" class="md-nav__link">
    3-1 下载一个简单的maven项目到本地
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-2-run-sonarscanner-from-the-docker-image" class="md-nav__link">
    3-2  Run SonarScanner from the Docker image
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-3-run-sonarscanner-on-linux-server" class="md-nav__link">
    3-3  Run SonarScanner on Linux server
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    4、使用流水线进行自动化代码扫描
  </a>
  
    <nav class="md-nav" aria-label="4、使用流水线进行自动化代码扫描">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#4-1-sonarqube-scanner-sharedlibrary" class="md-nav__link">
    4-1 填写sonarqube scanner到 sharedlibrary
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-2-pipeline-sharedlibrary" class="md-nav__link">
    4-2 Pipeline调用 sharedlibrary
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-3-console-output" class="md-nav__link">
    4-3 Console Output
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-sonar" class="md-nav__link">
    5、使用 Sonar 插件完成代码扫描
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5sonarqube" class="md-nav__link">
    5、SonarQube 项目管理
  </a>
  
    <nav class="md-nav" aria-label="5、SonarQube 项目管理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#5-1-sonarqube-quality-profiles" class="md-nav__link">
    5-1 SonarQube - 创建新的Quality Profiles
  </a>
  
    <nav class="md-nav" aria-label="5-1 SonarQube - 创建新的Quality Profiles">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#5-1-1-activate-more-rules-for-demo-profiles" class="md-nav__link">
    5-1-1 Activate more rules for demo Profiles
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-1-2-add-demo-profiles-to-the-projects" class="md-nav__link">
    5-1-2 Add demo Profiles to the projects
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-2-sonarqube-quality-gates" class="md-nav__link">
    5-2 SonarQube - 创建新的Quality Gates
  </a>
  
    <nav class="md-nav" aria-label="5-2 SonarQube - 创建新的Quality Gates">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#5-2-1-add-condition-to-the-quality-gates-for-projects" class="md-nav__link">
    5-2-1 Add condition to the Quality Gates for projects
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-2-2-run-failed-becuase-of-condition" class="md-nav__link">
    5-2-2 Run failed becuase of condition
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-3-jenkins-pipeline-sonarqube-sonarqube-plugin-function" class="md-nav__link">
    5-3 在jenkins pipeline获取 SonarQube 检测结果 (SonarQube plugin function）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-4-jenkins-pipeline-sonarqube-sonarqube-api" class="md-nav__link">
    5-4 在jenkins pipeline获取 SonarQube 检测结果 (SonarQube API）
  </a>
  
    <nav class="md-nav" aria-label="5-4 在jenkins pipeline获取 SonarQube 检测结果 (SonarQube API）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#5-4-1-sonarqube-credentials-jenkins" class="md-nav__link">
    5-4-1 添加 SonarQube credentials到  Jenkins中
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-4-2-jenkinslibtestsrcorgdevopssonarapigroovy" class="md-nav__link">
    5-4-2 JenkinslibTest/src/org/devops/sonarapi.groovy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-4-4-pipeline-sonar-api" class="md-nav__link">
    5-4-4  Pipeline 调用sonar api
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-sonarqube-api-way" class="md-nav__link">
    6、 SonarQube 搜索与新建项目(API WAY)
  </a>
  
    <nav class="md-nav" aria-label="6、 SonarQube 搜索与新建项目(API WAY)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#6-1" class="md-nav__link">
    6-1 查找项目
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-2" class="md-nav__link">
    6-2 创建新项目
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-2-pipeline" class="md-nav__link">
    6-2  搜索与新建项目在Pipeline
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7" class="md-nav__link">
    7 配置质量规则与质量阈
  </a>
  
    <nav class="md-nav" aria-label="7 配置质量规则与质量阈">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#7-1" class="md-nav__link">
    7-1 配置项目质量规则
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-2" class="md-nav__link">
    7-2 配置项目质量阈
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-3-default-qualitygatesdefault-qualityfiles" class="md-nav__link">
    7-3 使用default QualityGates或者default Qualityfiles
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-4-sharedlib-and-pipeline" class="md-nav__link">
    7-4 最终版本(sharedlib and pipeline)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-sonar" class="md-nav__link">
    8 Sonar 配置项目多分支模式
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
      
      
      
        <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
          九、制品库集成
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          九、制品库集成
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/chap9_artifact0/" class="md-nav__link">
        第一节 Sonatype Nexus 基本介绍与安装
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/chap9_artifact1/" class="md-nav__link">
        第二节 制品管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/chap9_artifact2/" class="md-nav__link">
        第三节 Nexus 制品上传
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/chap9_artifact3/" class="md-nav__link">
        第四节 Jenkins & Jfrog Artifactory
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/chap9_5nexus_2023/" class="md-nav__link">
        第五节 Jenkins流水线将制品发布到Nexus存储库
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
      
      
      
        <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
          十、需求管理工具集成
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_11">
          <span class="md-nav__icon md-icon"></span>
          十、需求管理工具集成
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap10/1chap10_jira_install/" class="md-nav__link">
        第一节 k8s 安装本地 Jira 服务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap10/2chap10_jira_gilab/" class="md-nav__link">
        第二节 Jenkins 配置端到端流水线（Jira和Gitlab的集成）
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" >
      
      
      
        <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="0">
          十一、Docker 集成
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_12">
          <span class="md-nav__icon md-icon"></span>
          十一、Docker 集成
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap11/1Docker_agents/" class="md-nav__link">
        第一节 基于 Docker 配置构建资源池
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap11/2Docker_pipeline/" class="md-nav__link">
        第二节 基于Docker的pipeline流水线
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap11/3Docker_registry/" class="md-nav__link">
        第三节 构建应用镜像到镜像仓库管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap11/4Docker_groovy/" class="md-nav__link">
        第四节 使用Groovy代码初始化Docker配置
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" >
      
      
      
        <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
          十二、K8S 平台集成
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_13">
          <span class="md-nav__icon md-icon"></span>
          十二、K8S 平台集成
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap12/1k8s_install/" class="md-nav__link">
        K8S 平台集成(全)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap12/2K8s_pipeline/" class="md-nav__link">
        使用 Jenkins Pipeline 流水线部署 Kubernetes 应用
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_14" >
      
      
      
        <label class="md-nav__link" for="__nav_14" id="__nav_14_label" tabindex="0">
          十三、自动化接口测试
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_14_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_14">
          <span class="md-nav__icon md-icon"></span>
          十三、自动化接口测试
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap13/1jmeter/" class="md-nav__link">
        第一节 Jmeter & Ant 自动化测试
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap13/2jenkins_jmeter/" class="md-nav__link">
        第二节 Jenkins、Ant、Jmeter 自动化测试
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_15" >
      
      
      
        <label class="md-nav__link" for="__nav_15" id="__nav_15_label" tabindex="0">
          十四、流水线最佳实践
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_15_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_15">
          <span class="md-nav__icon md-icon"></span>
          十四、流水线最佳实践
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap14/1JIRA_JEN_K8S/" class="md-nav__link">
        第一节 基于Jira端到端流水线的最佳实践
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap14/2JEN_K8S_API/" class="md-nav__link">
        第二节 Jenkins K8S Gitlab 集成
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap14/3Jen_k8s_pipeline/" class="md-nav__link">
        第三节 Jenkins + K8S + Gitlab 构建 RLEASE 打包发布更新流水线到K8S集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap14/4Jen_update_deploy_pip/" class="md-nav__link">
        第四节 版本晋级及发布流水线
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap14/5back_front_pipeline/" class="md-nav__link">
        第五节 前端后端项目发布流水线（Java+Nodejs)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap14/6Android_pipeline/" class="md-nav__link">
        第六节 构建Android项目流水线
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap14/7Jenkins_azure_mern/" class="md-nav__link">
        第七节 基于Azure部署Jenkins服务并开发MERN应用的CI/CD构建管道
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap14/2TMF_JENKINS/" class="md-nav__link">
        第八节 基础设施即代码 - 使用Terraform创建AWS EC2实例并部署Jenkins服务
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_16" >
      
      
      
        <label class="md-nav__link" for="__nav_16" id="__nav_16_label" tabindex="0">
          十五、监控与API调用
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_16_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_16">
          <span class="md-nav__icon md-icon"></span>
          十五、监控与API调用
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap15/1Jenkins_Prometheus/" class="md-nav__link">
        第一节 使用 Prometheus 监控 Jenkins
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap15/2Jenkins_InfluxDB_Grafana/" class="md-nav__link">
        第二节 Jenkins+InfluxDB+Grafana 收集构建数据
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap15/3Jenkins_python_API/" class="md-nav__link">
        第三节 Jenkins Python API 实践
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap15/4Jenkins_REST_API/" class="md-nav__link">
        第四节 Jenkins REST API 使用实践
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap15/5Jenkins_DSL/" class="md-nav__link">
        第五节 Jenkins Core Api & Job DSL创建项目
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_17" >
      
      
      
        <label class="md-nav__link" for="__nav_17" id="__nav_17_label" tabindex="0">
          十六、持续交付理论分析
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_17_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_17">
          <span class="md-nav__icon md-icon"></span>
          十六、持续交付理论分析
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap16/1cd_intro/" class="md-nav__link">
        L1 量身定制你的持续交付体系
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap16/2config_mgt/" class="md-nav__link">
        L2 配置管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap16/3Env_mgt/" class="md-nav__link">
        L3 环境管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap16/4const_mgt/" class="md-nav__link">
        L4 构建集成
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap16/5Mon_mgt/" class="md-nav__link">
        L5 发布及监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap16/6Test_mgt/" class="md-nav__link">
        L6 测试管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap16/7CD_pla/" class="md-nav__link">
        L7 持续交付平台化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap16/8Real_exp/" class="md-nav__link">
        L8 实践案例
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap16/9cicd_rev/" class="md-nav__link">
        L9 持续交付理论总结及面试
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_18" >
      
      
      
        <label class="md-nav__link" for="__nav_18" id="__nav_18_label" tabindex="0">
          Extra 知识扩展
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_18_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_18">
          <span class="md-nav__icon md-icon"></span>
          Extra 知识扩展
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Mkdocs_github_travis/" class="md-nav__link">
        GitHub+Travis+Mkdocs自动化构建文档库
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-sonarqube" class="md-nav__link">
    1、 SonarQube 平台简介与配置
  </a>
  
    <nav class="md-nav" aria-label="1、 SonarQube 平台简介与配置">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-1" class="md-nav__link">
    1-1 工作流程
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-2-sonarqube" class="md-nav__link">
    1-2 SonarQube安装
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-3" class="md-nav__link">
    1-3 服务集成
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2sonarqube" class="md-nav__link">
    2、SonarQube 扫描仪配置
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3sonarqube" class="md-nav__link">
    3、SonarQube 本地使用扫描仪项目分析配置
  </a>
  
    <nav class="md-nav" aria-label="3、SonarQube 本地使用扫描仪项目分析配置">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#3-1-maven" class="md-nav__link">
    3-1 下载一个简单的maven项目到本地
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-2-run-sonarscanner-from-the-docker-image" class="md-nav__link">
    3-2  Run SonarScanner from the Docker image
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-3-run-sonarscanner-on-linux-server" class="md-nav__link">
    3-3  Run SonarScanner on Linux server
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    4、使用流水线进行自动化代码扫描
  </a>
  
    <nav class="md-nav" aria-label="4、使用流水线进行自动化代码扫描">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#4-1-sonarqube-scanner-sharedlibrary" class="md-nav__link">
    4-1 填写sonarqube scanner到 sharedlibrary
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-2-pipeline-sharedlibrary" class="md-nav__link">
    4-2 Pipeline调用 sharedlibrary
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-3-console-output" class="md-nav__link">
    4-3 Console Output
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-sonar" class="md-nav__link">
    5、使用 Sonar 插件完成代码扫描
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5sonarqube" class="md-nav__link">
    5、SonarQube 项目管理
  </a>
  
    <nav class="md-nav" aria-label="5、SonarQube 项目管理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#5-1-sonarqube-quality-profiles" class="md-nav__link">
    5-1 SonarQube - 创建新的Quality Profiles
  </a>
  
    <nav class="md-nav" aria-label="5-1 SonarQube - 创建新的Quality Profiles">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#5-1-1-activate-more-rules-for-demo-profiles" class="md-nav__link">
    5-1-1 Activate more rules for demo Profiles
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-1-2-add-demo-profiles-to-the-projects" class="md-nav__link">
    5-1-2 Add demo Profiles to the projects
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-2-sonarqube-quality-gates" class="md-nav__link">
    5-2 SonarQube - 创建新的Quality Gates
  </a>
  
    <nav class="md-nav" aria-label="5-2 SonarQube - 创建新的Quality Gates">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#5-2-1-add-condition-to-the-quality-gates-for-projects" class="md-nav__link">
    5-2-1 Add condition to the Quality Gates for projects
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-2-2-run-failed-becuase-of-condition" class="md-nav__link">
    5-2-2 Run failed becuase of condition
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-3-jenkins-pipeline-sonarqube-sonarqube-plugin-function" class="md-nav__link">
    5-3 在jenkins pipeline获取 SonarQube 检测结果 (SonarQube plugin function）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-4-jenkins-pipeline-sonarqube-sonarqube-api" class="md-nav__link">
    5-4 在jenkins pipeline获取 SonarQube 检测结果 (SonarQube API）
  </a>
  
    <nav class="md-nav" aria-label="5-4 在jenkins pipeline获取 SonarQube 检测结果 (SonarQube API）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#5-4-1-sonarqube-credentials-jenkins" class="md-nav__link">
    5-4-1 添加 SonarQube credentials到  Jenkins中
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-4-2-jenkinslibtestsrcorgdevopssonarapigroovy" class="md-nav__link">
    5-4-2 JenkinslibTest/src/org/devops/sonarapi.groovy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-4-4-pipeline-sonar-api" class="md-nav__link">
    5-4-4  Pipeline 调用sonar api
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-sonarqube-api-way" class="md-nav__link">
    6、 SonarQube 搜索与新建项目(API WAY)
  </a>
  
    <nav class="md-nav" aria-label="6、 SonarQube 搜索与新建项目(API WAY)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#6-1" class="md-nav__link">
    6-1 查找项目
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-2" class="md-nav__link">
    6-2 创建新项目
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-2-pipeline" class="md-nav__link">
    6-2  搜索与新建项目在Pipeline
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7" class="md-nav__link">
    7 配置质量规则与质量阈
  </a>
  
    <nav class="md-nav" aria-label="7 配置质量规则与质量阈">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#7-1" class="md-nav__link">
    7-1 配置项目质量规则
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-2" class="md-nav__link">
    7-2 配置项目质量阈
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-3-default-qualitygatesdefault-qualityfiles" class="md-nav__link">
    7-3 使用default QualityGates或者default Qualityfiles
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-4-sharedlib-and-pipeline" class="md-nav__link">
    7-4 最终版本(sharedlib and pipeline)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-sonar" class="md-nav__link">
    8 Sonar 配置项目多分支模式
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="sonarqube-final-edition"><strong>第四季 代码质量平台集成(SonarQube Final Edition)</strong></h1>
<h2 id="1-sonarqube">1、 SonarQube 平台简介与配置</h2>
<ol>
<li>
<p>一台SonarQube Server启动3个主要过程： </p>
<ol>
<li>Web服务器，供开发人员，管理人员浏览高质量的快照并配置SonarQube实例 </li>
<li>基于<code>Elasticsearch</code>的<code>Search Server</code>从<code>UI</code>进行后退搜索 </li>
<li><code>Compute Engine</code>服务器，负责处理代码分析报告并将其保存在<code>SonarQube</code>数据库中 </li>
</ol>
</li>
<li>
<p>一个SonarQube数据库要存储： </p>
<ol>
<li>SonarQube实例的配置（安全性，插件设置等） </li>
<li>项目，视图等的质量诀照。 </li>
</ol>
</li>
<li>服务器上安装了多个<code>SonarQube</code>插件，可能包括语言，SCM，集成，身份验证和管理插件 </li>
<li>在构建／持续集成服务器上运行一个或多个<code>SonarScanner</code>，以分析项目 </li>
</ol>
<p><strong>组件组成</strong></p>
<ol>
<li>sonarqube server ： 他有三个程序分别是 <code>webserver</code>（配置和管理sonar） <code>searchserver</code>（搜索结果返回给<code>sonarUI</code>）  <code>ComplateEngineserver</code>（计算服务 将分析结果入库）。</li>
<li><code>sonarqube db</code> : 数据库 存放配置。</li>
<li><code>sonarqube plugins</code>： 插件增加功能。</li>
<li><code>sonar-scanner</code> ： 代码扫描工具可以有多个。</li>
</ol>
<p><img alt="Alt Image Text" src="../../images/chp8_4_1.png" title="Body image" /></p>
<h3 id="1-1">1-1 工作流程</h3>
<p><img alt="Alt Image Text" src="../../images/chp8_4_2.png" title="Body image" /></p>
<p>下面的模式展示了SonarQube如何与其他ALM工具集成，以及使用SONARQUE的各种组件。</p>
<ul>
<li>开发人员在IDE中编写代码，并使用SONARLILT来运行本地分析</li>
<li>开发人员将他们的代码推到他们最喜欢的SCM：Git，Svn，TFVC，…</li>
<li>连续集成服务器触发自动构建，执行SONARQUE扫描器需要运行SONARQUE分析。</li>
<li>分析报告被发送到SONARQUE服务器进行处理。</li>
<li>SONARQUE服务器在SONARQUE数据库中处理和存储分析报告结果，并将结果显示在UI中。</li>
<li>开发人员审查、评论、挑战他们的问题，通过SONARQUE UI管理和减少他们的技术债务。</li>
<li>管理者从分析中得到报告。</li>
<li><code>OPS</code>使用API来自动配置并从<code>SONARQUE</code>中提取数据。</li>
<li><code>OPS</code>使用JMX监控SONARQUBE服务器</li>
</ul>
<h3 id="1-2-sonarqube">1-2 SonarQube安装</h3>
<p><strong>On server</strong></p>
<ul>
<li>运行<code>SonarQube</code>的唯一前提条件是在计算机上安装Java (Oracle JRE 11或OpenJDK 11) </li>
<li>实例至少需要<code>2GB</code>的<code>RAM</code>才能有效运行，而<code>OS</code>则需要<code>1GB</code>的可用<code>RAM</code> </li>
<li>每个节点分配<code>50Gb</code>的驱动器空间 </li>
<li>安装在具有出色读写性能的硬盘驱动器上（“数据”文件夹中包含<code>Elasticsearch</code>索引，当服务器启动并运行时，将在该索引上进行大量的I/O) </li>
<li><code>SonarQube</code>在服务器端不支持<code>32</code>位系统。但是，<code>SonarQube</code>确实在扫描仪侧支持<code>32</code>位系统。 </li>
</ul>
<p><strong>支持平台</strong></p>
<ul>
<li>运行<code>SonarQube</code>的唯一前提条件是在计算机上安装<code>Java (Oracle JRE 11</code>或<code>Open.JDK 11</code>) </li>
</ul>
<p><img alt="Alt Image Text" src="../../images/chp8_4_3.png" title="Body image" /></p>
<pre><code>sysctl -w vm.max_ma_count=262144 
sysctl -w fs.file-max=65536
ulimit -n 65536 
ulimit -u 4096 
</code></pre>
<p><strong>Install For Docker</strong></p>
<pre><code>docker run --rm -d --name sonarqube \ 
-p 9000:9000 \ 
-v ${LOCALDIR}/sonar/sonarqube_conf:/opt/sonarqube/conf \
-v ${LOCALDIR}/sonar/sonarqube_extensions:/opt/sonarqube/extensions \ 
-v ${LOCALDIR}/sonar/sonarqube_logs:/opt/sonarqube/logs \ 
-v ${LOCALDIR}/sonar/sonarqube data:/opt/sonarqube/data \ 
sonarqube:8.4.1-community 
</code></pre>
<h3 id="1-3">1-3 服务集成</h3>
<p><strong>LDAPS</strong></p>
<p><img alt="Alt Image Text" src="../../images/chp8_4_4.png" title="Body image" /></p>
<pre><code>vim sonarqube_conf/sonar.properties


#LDAP sesttings 
#admin 

sonar.security.realm=LDAP 
ldap.url=ldap://192.168.1.200:389 
ldap.bindDn=cn=admin,dc=devops,dc=com 
ldap.bindPassword=ldap123 

# users
ldap.user.baseDn=ou=jenkins,dc=devops,dc=com 
ldap.user.request= (&amp;(objectClass=inetOrgPerson)(cn={login})) 
ldap.user.realNameAttribute=cn 
ldap.user.emailAttribute=mail
</code></pre>
<p><strong>gitlab integration</strong></p>
<ul>
<li>gitlab part</li>
</ul>
<p><code>admin/applications</code></p>
<ul>
<li>http://localhost:32314/oauth2/callback/gitlab</li>
<li>Application ID: 706e48d74eabfb7330beaf747732182833ceb79fa43ac180e248a4b77f55cfed</li>
<li>Secret: 646b3c54b4244d0fc5ccf8cf906728c2818a60e285675186dd731b21a189c0c8</li>
</ul>
<p><img alt="Alt Image Text" src="../../images/chp8_4_6.png" title="Body image" /></p>
<ul>
<li><code>admin/settings?category=almintegration</code></li>
</ul>
<p><img alt="Alt Image Text" src="../../images/chp8_4_5.png" title="Body image" /></p>
<h2 id="2sonarqube">2、<code>SonarQube</code> 扫描仪配置</h2>
<p>https://docs.sonarqube.org/display/SCAN/Analyzing+with+SonarQube+Scanner  </p>
<h2 id="3sonarqube">3、<code>SonarQube</code> 本地使用扫描仪项目分析配置</h2>
<h3 id="3-1-maven">3-1 下载一个简单的<code>maven</code>项目到本地</h3>
<pre><code>$ git clone https://github.com/zeyangli/simple-java-maven-app
$ cd simple-java-maven-app
$ mv simple-java-maven-app demo-maven-service
$ mvn clean package

[INFO] Scanning for projects...
[INFO] 
[INFO] ----------------------&lt; com.mycompany.app:my-app &gt;----------------------
[INFO] Building my-app 1.1-SNAPSHOT
[INFO] --------------------------------[ jar ]---------------------------------
[INFO] 
[INFO] --- maven-clean-plugin:2.5:clean (default-clean) @ my-app ---
[INFO] 
[INFO] --- maven-resources-plugin:2.6:resources (default-resources) @ my-app ---
[WARNING] Using platform encoding (UTF-8 actually) to copy filtered resources, i.e. build is platform dependent!
[INFO] skip non existing resourceDirectory /home/vagrant/test/simple-java-maven-app/src/main/resources
[INFO] 
[INFO] --- maven-compiler-plugin:3.1:compile (default-compile) @ my-app ---
[INFO] Changes detected - recompiling the module!
[WARNING] File encoding has not been set, using platform encoding UTF-8, i.e. build is platform dependent!
[INFO] Compiling 1 source file to /home/vagrant/test/simple-java-maven-app/target/classes
[INFO] 
[INFO] --- maven-resources-plugin:2.6:testResources (default-testResources) @ my-app ---
[WARNING] Using platform encoding (UTF-8 actually) to copy filtered resources, i.e. build is platform dependent!
[INFO] skip non existing resourceDirectory /home/vagrant/test/simple-java-maven-app/src/test/resources
[INFO] 
[INFO] --- maven-compiler-plugin:3.1:testCompile (default-testCompile) @ my-app ---
[INFO] Changes detected - recompiling the module!
[WARNING] File encoding has not been set, using platform encoding UTF-8, i.e. build is platform dependent!
[INFO] Compiling 1 source file to /home/vagrant/test/simple-java-maven-app/target/test-classes
[INFO] 
[INFO] --- maven-surefire-plugin:2.12.4:test (default-test) @ my-app ---
[INFO] Surefire report directory: /home/vagrant/test/simple-java-maven-app/target/surefire-reports

-------------------------------------------------------
 T E S T S
-------------------------------------------------------
Running com.mycompany.app.AppTest
Tests run: 2, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.075 sec

Results :

Tests run: 2, Failures: 0, Errors: 0, Skipped: 0

[INFO] 
[INFO] --- maven-jar-plugin:3.0.2:jar (default-jar) @ my-app ---
[INFO] Building jar: /home/vagrant/test/simple-java-maven-app/target/my-app-1.1-SNAPSHOT.jar
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  5.512 s
[INFO] Finished at: 2020-08-01T06:10:01Z
[INFO] ------------------------------------------------------------------------
</code></pre>
<pre><code>$ tree target/
target/
├── classes
│   └── com
│       └── mycompany
│           └── app
│               └── App.class
├── maven-archiver
│   └── pom.properties
├── maven-status
│   └── maven-compiler-plugin
│       ├── compile
│       │   └── default-compile
│       │       ├── createdFiles.lst
│       │       └── inputFiles.lst
│       └── testCompile
│           └── default-testCompile
│               ├── createdFiles.lst
│               └── inputFiles.lst
├── my-app-1.1-SNAPSHOT.jar
├── surefire-reports
│   ├── com.mycompany.app.AppTest.txt
│   └── TEST-com.mycompany.app.AppTest.xml
└── test-classes
    └── com
        └── mycompany
            └── app
                └── AppTest.class

16 directories, 10 files
</code></pre>
<h3 id="3-2-run-sonarscanner-from-the-docker-image">3-2  Run SonarScanner from the Docker image</h3>
<pre><code>docker run \
    --rm \
    -e SONAR_HOST_URL=&quot;http://192.168.33.1:32314&quot; \
    -e SONAR_LOGIN=&quot;admin&quot; \
    -e SONAR_PASSWORD=&quot;admin&quot; \
    -v &quot;/home/vagrant/tools/sonar:/usr/src&quot; \
    sonarsource/sonar-scanner-cli -Dsonar.projectKey=demo-maven-service
</code></pre>
<pre><code>docker run \
    --rm \
    -e SONAR_HOST_URL=&quot;http://${SONARQUBE_URL}&quot; \
    -v &quot;${YOUR_REPO}:/usr/src&quot; \
    sonarsource/sonar-scanner-cli
</code></pre>
<pre><code>$ docker run \
&gt;     --rm \
&gt;     -e SONAR_HOST_URL=&quot;http://192.168.33.1:32314&quot; \
&gt;     -e SONAR_LOGIN=&quot;admin&quot; \
&gt;     -e SONAR_PASSWORD=&quot;admin&quot; \
&gt;     -v &quot;/home/vagrant/tools/sonar:/usr/src&quot; \
&gt;     sonarsource/sonar-scanner-cli -Dsonar.projectKey=demo-maven-service
INFO: Scanner configuration file: /opt/sonar-scanner/conf/sonar-scanner.properties
INFO: Project root configuration file: NONE
INFO: SonarScanner 4.4.0.2170
INFO: Java 11.0.6 AdoptOpenJDK (64-bit)
INFO: Linux 3.10.0-957.12.2.el7.x86_64 amd64
INFO: User cache: /opt/sonar-scanner/.sonar/cache
INFO: Scanner configuration file: /opt/sonar-scanner/conf/sonar-scanner.properties
INFO: Project root configuration file: NONE
INFO: Analyzing on SonarQube server 8.4.1
INFO: Default locale: &quot;en_US&quot;, source code encoding: &quot;UTF-8&quot; (analysis is platform dependent)
INFO: Load global settings
INFO: Load global settings (done) | time=376ms
INFO: Server id: EA8D9556-AXOeledPvj9r7r4MIG91
INFO: User cache: /opt/sonar-scanner/.sonar/cache
INFO: Load/download plugins
INFO: Load plugins index
INFO: Load plugins index (done) | time=341ms
INFO: Load/download plugins (done) | time=8919ms
INFO: Process project properties
INFO: Process project properties (done) | time=1ms
INFO: Execute project builders
INFO: Execute project builders (done) | time=7ms
INFO: Project key: demo-maven-service
INFO: Base dir: /usr/src
INFO: Working dir: /usr/src/.scannerwork
INFO: Load project settings for component key: 'demo-maven-service'
INFO: Load quality profiles
INFO: Load quality profiles (done) | time=754ms
INFO: Load active rules
INFO: Load active rules (done) | time=6033ms
WARN: SCM provider autodetection failed. Please use &quot;sonar.scm.provider&quot; to define SCM of your project, or disable the SCM Sensor in the project settings.
INFO: Indexing files...
INFO: Project configuration:
INFO: 1 file indexed
INFO: ------------- Run sensors on module demo-maven-service
INFO: Load metrics repository
INFO: Load metrics repository (done) | time=365ms
WARNING: An illegal reflective access operation has occurred
WARNING: Illegal reflective access by net.sf.cglib.core.ReflectUtils$1 (file:/opt/sonar-scanner/.sonar/cache/52f5340dd05620cd162e2b9a45a57124/sonar-javascript-plugin.jar) to method java.lang.ClassLoader.defineClass(java.lang.String,byte[],int,int,java.security.ProtectionDomain)
WARNING: Please consider reporting this to the maintainers of net.sf.cglib.core.ReflectUtils$1
WARNING: Use --illegal-access=warn to enable warnings of further illegal reflective access operations
WARNING: All illegal access operations will be denied in a future release
INFO: Sensor SonarCSS Rules [cssfamily]
INFO: No CSS, PHP, HTML or VueJS files are found in the project. CSS analysis is skipped.
INFO: Sensor SonarCSS Rules [cssfamily] (done) | time=1ms
INFO: Sensor JaCoCo XML Report Importer [jacoco]
INFO: 'sonar.coverage.jacoco.xmlReportPaths' is not defined. Using default locations: target/site/jacoco/jacoco.xml,target/site/jacoco-it/jacoco.xml,build/reports/jacoco/test/jacocoTestReport.xml
INFO: No report imported, no coverage information will be imported by JaCoCo XML Report Importer
INFO: Sensor JaCoCo XML Report Importer [jacoco] (done) | time=2ms
INFO: Sensor JavaXmlSensor [java]
INFO: Sensor JavaXmlSensor [java] (done) | time=0ms
INFO: Sensor HTML [web]
INFO: Sensor HTML [web] (done) | time=8ms
INFO: ------------- Run sensors on project
INFO: Sensor Zero Coverage Sensor
INFO: Sensor Zero Coverage Sensor (done) | time=9ms
INFO: SCM Publisher No SCM system was detected. You can use the 'sonar.scm.provider' property to explicitly specify it.
INFO: CPD Executor Calculating CPD for 0 files
INFO: CPD Executor CPD calculation finished (done) | time=0ms
INFO: Analysis report generated in 202ms, dir size=79 KB
INFO: Analysis report compressed in 39ms, zip size=10 KB
INFO: Analysis report uploaded in 623ms
INFO: ANALYSIS SUCCESSFUL, you can browse http://192.168.33.1:32314/dashboard?id=demo-maven-service
INFO: Note that you will be able to access the updated dashboard once the server has processed the submitted analysis report
INFO: More about the report processing at http://192.168.33.1:32314/api/ce/task?id=AXOztIcYdI8p8GdhXo8N
INFO: Analysis total time: 13.094 s
INFO: ------------------------------------------------------------------------
INFO: EXECUTION SUCCESS
INFO: ------------------------------------------------------------------------
INFO: Total time: 25.064s
INFO: Final Memory: 6M/37M
INFO: ------------------------------------------------------------------------
</code></pre>
<h3 id="3-3-run-sonarscanner-on-linux-server">3-3  Run SonarScanner on Linux server</h3>
<pre><code>cd /usr/local/
sudo wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.4.0.2170-linux.zip
unzip sonar-scanner-cli-4.4.0.2170-linux.zip
mv sonar-scanner-cli-4.4.0.2170-linux sonar-scanner

cd /usr/local/sonar-scanner
$ tree bin/
bin/
├── sonar-scanner
└── sonar-scanner-debug

0 directories, 2 files

$ tree conf/
conf/
└── sonar-scanner.properties

0 directories, 1 file

sudo vim /usr/local/sonar-scanner/conf/sonar-scanner.properties

...
sonar.host.url=http://192.168.33.1:32314
</code></pre>
<p>sudo vim /etc/profile.d/scanner.sh</p>
<p>export SONAR_HOME=/usr/local/sonar-scanner/
export PATH=$PATH:$SONAR_HOME/bin</p>
<pre><code>cd demo-maven-service
vim sonarqube.sh

# can run the command in script
sonar-scanner -Dsonar.host.url=http://192.168.33.1:32314 \
-Dsonar.projectKey=demomavenservice \
-Dsonar.projectName=demomavenservice \
--define sonar.login=admin \
--define sonar.password=admin \
--define sonar.projectVersion=1.0 \
--define sonar.ws.timeout=30 \
--define sonar.projectDescription=&quot;my first project&quot; \
--define sonar.links.homepage=http://www.baidu.com  \
--define sonar.sources=src \
--define sonar.sourceEncoding=UTF-8 \
--define sonar.java.binaries=target/classes \
--define sonar.java.test.binaries=target/test—classes \
--define sonar.java.surefire.report=target/surefire—reports
</code></pre>
<p><strong>Run the script</strong></p>
<pre><code>source sonarqube.sh
INFO: Scanner configuration file: /usr/local/sonar-scanner/conf/sonar-scanner.properties
INFO: Project root configuration file: NONE
INFO: SonarScanner 4.4.0.2170
INFO: Java 11.0.3 AdoptOpenJDK (64-bit)
INFO: Linux 3.10.0-957.12.2.el7.x86_64 amd64
INFO: User cache: /home/vagrant/.sonar/cache
INFO: Scanner configuration file: /usr/local/sonar-scanner/conf/sonar-scanner.properties
INFO: Project root configuration file: NONE
INFO: Analyzing on SonarQube server 8.4.1
INFO: Default locale: &quot;en_US&quot;, source code encoding: &quot;UTF-8&quot;
INFO: Load global settings
INFO: Load global settings (done) | time=377ms
INFO: Server id: EA8D9556-AXOeledPvj9r7r4MIG91
INFO: User cache: /home/vagrant/.sonar/cache
...
INFO: Analysis report compressed in 71ms, zip size=14 KB
INFO: Analysis report uploaded in 378ms
INFO: ANALYSIS SUCCESSFUL, you can browse http://192.168.33.1:32314/dashboard?id=demomavenservice
INFO: Note that you will be able to access the updated dashboard once the server has processed the submitted analysis report
INFO: More about the report processing at http://192.168.33.1:32314/api/ce/task?id=AXO4OmSidI8p8GdhXo8b
INFO: Analysis total time: 14.196 s
INFO: ------------------------------------------------------------------------
INFO: EXECUTION SUCCESS
INFO: ------------------------------------------------------------------------
INFO: Total time: 16.430s
INFO: Final Memory: 16M/61M
INFO: ------------------------------------------------------------------------
</code></pre>
<p><img alt="Alt Image Text" src="../../images/chp8_4_7.png" title="Body image" /></p>
<h2 id="4">4、使用流水线进行自动化代码扫描</h2>
<h3 id="4-1-sonarqube-scanner-sharedlibrary">4-1 填写<code>sonarqube scanner</code>到 <code>sharedlibrary</code></h3>
<p><strong><code>JenkinslibTest/src/org/devops/sonarqube.groovy</code></strong></p>
<pre><code>package org.devops

//scan
def SonarScan(projectName,projectDesc,projectPath){
    def scannerHome = &quot;/usr/local/sonar-scanner/&quot;
    //定义服务器列表
    def sonarServers = &quot;http://192.168.33.1:32314&quot;
    def sonarDate = sh  returnStdout: true, script: 'date  +%Y%m%d%H%M%S'
    sonarDate = sonarDate - &quot;\n&quot;

    sh &quot;&quot;&quot; 
         ${scannerHome}/bin/sonar-scanner -Dsonar.host.url=${sonarServers} \
        -Dsonar.projectKey=${projectName} \
        -Dsonar.projectName=${projectName} \
        --define sonar.login=admin \
        --define sonar.password=admin \
        --define sonar.projectVersion=${sonarDate} \
        --define sonar.ws.timeout=30 \
        --define sonar.projectDescription=${projectDesc} \
        --define sonar.links.homepage=http://www.baidu.com  \
        --define sonar.sources=${projectPath} \
        --define sonar.sourceEncoding=UTF-8 \
        --define sonar.java.binaries=target/classes \
        --define sonar.java.test.binaries=target/test—classes \
        --define sonar.java.surefire.report=target/surefire—reports
    &quot;&quot;&quot;
}
</code></pre>
<h3 id="4-2-pipeline-sharedlibrary">4-2 <code>Pipeline</code>调用 <code>sharedlibrary</code></h3>
<pre><code>#!groovy
@Library('jenkinslib@master') _

def build = new org.devops.buildtools()
def sonar = new org.devops.sonarqube()

pipeline {
    agent { node { label &quot;hostmachine&quot; }}
    parameters {
        string(name: 'srcUrl', defaultValue: 'http://192.168.33.1:30088/root/demo-maven-service.git', description: '') 
        choice(name: 'branchName', choices: 'master\nstage\ndev', description: 'Please chose your branch')
        choice(name: 'buildType', choices: 'mvn', description: 'build tool')
        choice(name: 'buildShell', choices: 'clean package -DskipTest\n--version', description: 'build tool')
    }
    stages{
        stage('Checkout') {
            steps {
                script {
                    checkout([$class: 'GitSCM', branches: [[name: &quot;${branchName}&quot;]], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'gitlab-admin-user', url: &quot;${srcUrl}&quot;]]])
                } 
            }
        }

        stage('Build') {
            steps {
                script {
                    build.Build(buildType,buildShell)
                } 
            }
        }

        stage('Qa') {
            steps {
                script {
                    sonar.SonarScan(&quot;${JOB_NAME}&quot;,&quot;${JOB_NAME}&quot;,&quot;src&quot; )
                } 
            }
        }    
    }
 }
</code></pre>
<pre><code>stage('Qa') {
    steps {
        script {
            sonar.SonarScan(&quot;${JOB_NAME}&quot;,&quot;${JOB_NAME}&quot;,&quot;src&quot; )
        } 
    }
}
</code></pre>
<h3 id="4-3-console-output">4-3 Console Output</h3>
<pre><code>...
[Pipeline] sh
+ date +%Y%m%d%H%M%S
[Pipeline] sh
+ /usr/local/sonar-scanner//bin/sonar-scanner -Dsonar.host.url=http://192.168.33.1:32314 -Dsonar.projectKey=sq4scanner -Dsonar.projectName=sq4scanner --define sonar.login=admin --define sonar.password=admin --define sonar.projectVersion=20200801135329 --define sonar.ws.timeout=30 --define sonar.projectDescription=sq4scanner --define sonar.links.homepage=http://www.baidu.com --define sonar.sources=src --define sonar.sourceEncoding=UTF-8 --define sonar.java.binaries=target/classes --define sonar.java.test.binaries=target/test—classes --define sonar.java.surefire.report=target/surefire—reports
INFO: Scanner configuration file: /usr/local/sonar-scanner/conf/sonar-scanner.properties
INFO: Project root configuration file: NONE
INFO: SonarScanner 4.4.0.2170
...
INFO: ANALYSIS SUCCESSFUL, you can browse http://192.168.33.1:32314/dashboard?id=sq4scanner
INFO: Note that you will be able to access the updated dashboard once the server has processed the submitted analysis report
INFO: More about the report processing at http://192.168.33.1:32314/api/ce/task?id=AXO4zE_WdI8p8GdhXo8n
INFO: Analysis total time: 17.732 s
INFO: ------------------------------------------------------------------------
INFO: EXECUTION SUCCESS
INFO: ------------------------------------------------------------------------
INFO: Total time: 20.804s
INFO: Final Memory: 16M/62M
</code></pre>
<p><img alt="Alt Image Text" src="../../images/chp8_4_8.png" title="Body image" /></p>
<p><img alt="Alt Image Text" src="../../images/chp8_4_9.png" title="Body image" /></p>
<p><img alt="Alt Image Text" src="../../images/chp8_4_10.png" title="Body image" /></p>
<p><img alt="Alt Image Text" src="../../images/chp8_4_11.png" title="Body image" /></p>
<h2 id="5-sonar">5、使用 Sonar 插件完成代码扫描</h2>
<p><strong><a href="https://docs.sonarqube.org/latest/analysis/scan/sonarscanner-for-jenkins/">SonarScanner for Jenkins</a></strong></p>
<p><a href="../2chap8_code_quality_sonarqube/">Jenkins与SonarQube集成</a></p>
<p><strong><code>JenkinslibTest/src/org/devops/sonarqubeadv.groovy</code></strong></p>
<pre><code>package org.devops


//scan
def SonarScan(projectName,projectDesc,projectPath){

    withSonarQubeEnv(&quot;sonarqube&quot;){
        def scannerHome = &quot;/usr/local/sonar-scanner/&quot;
        def sonarServers = &quot;http://192.168.33.1:32314&quot;
        def sonarDate = sh  returnStdout: true, script: 'date  +%Y%m%d%H%M%S'
        sonarDate = sonarDate - &quot;\n&quot;


        sh &quot;&quot;&quot; 
            ${scannerHome}/bin/sonar-scanner -Dsonar.projectKey=${projectName} \
            -Dsonar.projectName=${projectName} \
            --define sonar.projectVersion=${sonarDate} \
            --define sonar.ws.timeout=30 \
            --define sonar.projectDescription=${projectDesc} \
            --define sonar.links.homepage=http://www.baidu.com \
            --define sonar.sources=${projectPath} \
            --define sonar.sourceEncoding=UTF-8 \
            --define sonar.java.binaries=target/classes \
            --define sonar.java.test.binaries=target/test-classes \
            --define sonar.java.surefire.report=target/surefire-reports
        &quot;&quot;&quot;
    }
}

</code></pre>
<pre><code> withSonarQubeEnv(&quot;sonarqube&quot;){

 }
</code></pre>
<ul>
<li><code>withSonarQubeEnv("sonarqube")</code> 配置在Jenkins中</li>
</ul>
<p><img alt="Alt Image Text" src="../../images/chp8_4_12.png" title="Body image" /></p>
<p><strong><code>pipeline.groovy</code></strong></p>
<pre><code>#!groovy
@Library('jenkinslib@master') _

def build = new org.devops.buildtools()
def sonar = new org.devops.sonarqube()
def sonaradv = new org.devops.sonarqubeadv()

pipeline {
    agent { node { label &quot;hostmachine&quot; }}
    parameters {
        string(name: 'srcUrl', defaultValue: 'http://192.168.33.1:30088/root/demo-maven-service.git', description: '') 
        choice(name: 'branchName', choices: 'master\nstage\ndev', description: 'Please chose your branch')
        choice(name: 'buildType', choices: 'mvn', description: 'build tool')
        choice(name: 'buildShell', choices: 'clean package -DskipTest\n--version', description: 'build tool')
    }
    stages{
        stage('Checkout') {
            steps {
                script {
                    checkout([$class: 'GitSCM', branches: [[name: &quot;${branchName}&quot;]], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'gitlab-admin-user', url: &quot;${srcUrl}&quot;]]])
                } 
            }
        }

        stage('Build') {
            steps {
                script {
                    build.Build(buildType,buildShell)
                } 
            }
        }

        stage('Qa') {
            steps {
                script {
                    sonaradv.SonarScan(&quot;${JOB_NAME}&quot;,&quot;${JOB_NAME}&quot;,&quot;src&quot; )
                } 
            }
        }    
    }
 }
</code></pre>
<ul>
<li><code>def sonaradv = new org.devops.sonarqubeadv()</code></li>
</ul>
<pre><code>stage('Qa') {
            steps {
                script {
                    sonaradv.SonarScan(&quot;${JOB_NAME}&quot;,&quot;${JOB_NAME}&quot;,&quot;src&quot; )
                } 
            }
        }
</code></pre>
<p><img alt="Alt Image Text" src="../../images/chp8_4_13.png" title="Body image" /></p>
<ul>
<li>点击<code>sonarqube tab</code></li>
</ul>
<p><img alt="Alt Image Text" src="../../images/chp8_4_14.png" title="Body image" /></p>
<h2 id="5sonarqube">5、SonarQube 项目管理</h2>
<h3 id="5-1-sonarqube-quality-profiles">5-1 SonarQube - 创建新的<code>Quality Profiles</code></h3>
<ul>
<li>Name: demo</li>
<li>Language: java</li>
</ul>
<p><img alt="Alt Image Text" src="../../images/chp8_4_15.png" title="Body image" /></p>
<h4 id="5-1-1-activate-more-rules-for-demo-profiles">5-1-1 Activate more rules for <code>demo</code> Profiles</h4>
<p><img alt="Alt Image Text" src="../../images/chp8_4_16.png" title="Body image" /></p>
<p><img alt="Alt Image Text" src="../../images/chp8_4_17.png" title="Body image" /></p>
<p><img alt="Alt Image Text" src="../../images/chp8_4_18.png" title="Body image" /></p>
<h4 id="5-1-2-add-demo-profiles-to-the-projects">5-1-2 Add <code>demo</code> Profiles to the projects</h4>
<p><img alt="Alt Image Text" src="../../images/chp8_4_19.png" title="Body image" /></p>
<p><img alt="Alt Image Text" src="../../images/chp8_4_20.png" title="Body image" /></p>
<h3 id="5-2-sonarqube-quality-gates">5-2 SonarQube - 创建新的<code>Quality Gates</code></h3>
<p><img alt="Alt Image Text" src="../../images/chp8_4_21.png" title="Body image" /></p>
<h4 id="5-2-1-add-condition-to-the-quality-gates-for-projects">5-2-1 Add condition to the Quality Gates for projects</h4>
<p><img alt="Alt Image Text" src="../../images/chp8_4_22.png" title="Body image" /></p>
<p><strong>Add more condition</strong></p>
<p><img alt="Alt Image Text" src="../../images/chp8_4_23.png" title="Body image" /></p>
<p><img alt="Alt Image Text" src="../../images/chp8_4_24.png" title="Body image" /></p>
<h4 id="5-2-2-run-failed-becuase-of-condition">5-2-2 Run failed becuase of condition</h4>
<p><img alt="Alt Image Text" src="../../images/chp8_4_25.png" title="Body image" /></p>
<h3 id="5-3-jenkins-pipeline-sonarqube-sonarqube-plugin-function">5-3 在<code>jenkins pipeline</code>获取 <code>SonarQube</code> 检测结果 (SonarQube plugin function）</h3>
<p><strong><code>JenkinslibTest/src/org/devops/sonarqubeadv.groovy</code></strong></p>
<pre><code>package org.devops


//scan
def SonarScan(projectName,projectDesc,projectPath){

    withSonarQubeEnv(&quot;sonarqube&quot;){
        def scannerHome = &quot;/usr/local/sonar-scanner/&quot;
        def sonarServers = &quot;http://192.168.33.1:32314&quot;
        def sonarDate = sh  returnStdout: true, script: 'date  +%Y%m%d%H%M%S'
        sonarDate = sonarDate - &quot;\n&quot;


        sh &quot;&quot;&quot; 
            ${scannerHome}/bin/sonar-scanner -Dsonar.projectKey=${projectName} \
            -Dsonar.projectName=${projectName} \
            --define sonar.projectVersion=${sonarDate} \
            --define sonar.ws.timeout=30 \
            --define sonar.projectDescription=${projectDesc} \
            --define sonar.links.homepage=http://www.baidu.com \
            --define sonar.sources=${projectPath} \
            --define sonar.sourceEncoding=UTF-8 \
            --define sonar.java.binaries=target/classes \
            --define sonar.java.test.binaries=target/test-classes \
            --define sonar.java.surefire.report=target/surefire-reports
        &quot;&quot;&quot;
    }

    def qg = waitForQualityGate()
    if (qg.status != 'OK') {
        error &quot;Pipeline aborted due to quality gate failure: ${qg.status}&quot;
    }
}
</code></pre>
<pre><code>def qg = waitForQualityGate()
    if (qg.status != 'OK') {
        error &quot;Pipeline aborted due to quality gate failure: ${qg.status}&quot;
    }
</code></pre>
<ul>
<li><a href="https://www.jenkins.io/doc/pipeline/steps/sonar/">waitForQualityGate</a></li>
<li><strong>waitForQualityGate</strong>: Wait for SonarQube analysis to be completed and return quality gate status</li>
</ul>
<p><strong>Pipeline script</strong></p>
<pre><code>#!groovy
@Library('jenkinslib@master') _

def build = new org.devops.buildtools()
def sonar = new org.devops.sonarqube()
def sonaradv = new org.devops.sonarqubeadv()

pipeline {
    agent { node { label &quot;hostmachine&quot; }}
    parameters {
        string(name: 'srcUrl', defaultValue: 'http://192.168.33.1:30088/root/demo-maven-service.git', description: '') 
        choice(name: 'branchName', choices: 'master\nstage\ndev', description: 'Please chose your branch')
        choice(name: 'buildType', choices: 'mvn', description: 'build tool')
        choice(name: 'buildShell', choices: 'clean package -DskipTest\n--version', description: 'build tool')
    }
    stages{
        stage('Checkout') {
            steps {
                script {
                    checkout([$class: 'GitSCM', branches: [[name: &quot;${branchName}&quot;]], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'gitlab-admin-user', url: &quot;${srcUrl}&quot;]]])
                } 
            }
        }

        stage('Build') {
            steps {
                script {
                    build.Build(buildType,buildShell)
                } 
            }
        }

        stage('Qa') {
            steps {
                script {
                    sonaradv.SonarScan(&quot;${JOB_NAME}&quot;,&quot;${JOB_NAME}&quot;,&quot;src&quot; )
                } 
            }
        }    
    }
 }
</code></pre>
<p><strong>Console output</strong></p>
<pre><code>...
[Pipeline] // withSonarQubeEnv
[Pipeline] waitForQualityGate
Checking status of SonarQube task 'AXO9Z_O3dI8p8GdhXo9M' on server 'sonarqube'
SonarQube task 'AXO9Z_O3dI8p8GdhXo9M' status is 'PENDING'
SonarQube task 'AXO9Z_O3dI8p8GdhXo9M' status is 'SUCCESS'
SonarQube task 'AXO9Z_O3dI8p8GdhXo9M' completed. Quality gate is 'ERROR'
[Pipeline] error
</code></pre>
<p><code>SonarQube</code> 的 <code>error</code> 会导致 <code>pipeline</code> 的失败</p>
<p><img alt="Alt Image Text" src="../../images/chp8_4_26.png" title="Body image" /></p>
<h3 id="5-4-jenkins-pipeline-sonarqube-sonarqube-api">5-4 在<code>jenkins pipeline</code>获取 <code>SonarQube</code> 检测结果 (SonarQube API）</h3>
<h4 id="5-4-1-sonarqube-credentials-jenkins">5-4-1 添加 <code>SonarQube credentials</code>到  <code>Jenkins</code>中</h4>
<ul>
<li><code>sonar-admin-user</code></li>
</ul>
<p><img alt="Alt Image Text" src="../../images/chp8_4_27.png" title="Body image" /></p>
<ul>
<li>查看 <code>SonarQube API</code>的返回</li>
</ul>
<pre><code> http://192.168.33.1:32314/api/qualitygates/project_status?projectKey=sq5scanner

{
   &quot;projectStatus&quot;:{
      &quot;status&quot;:&quot;ERROR&quot;,
      &quot;conditions&quot;:[
         {
            &quot;status&quot;:&quot;OK&quot;,
            &quot;metricKey&quot;:&quot;coverage&quot;,
            &quot;comparator&quot;:&quot;LT&quot;,
            &quot;errorThreshold&quot;:&quot;0&quot;,
            &quot;actualValue&quot;:&quot;0.0&quot;
         },
         {
            &quot;status&quot;:&quot;ERROR&quot;,
            &quot;metricKey&quot;:&quot;code_smells&quot;,
            &quot;comparator&quot;:&quot;GT&quot;,
            &quot;errorThreshold&quot;:&quot;1&quot;,
            &quot;actualValue&quot;:&quot;3&quot;
         }
      ],
      &quot;periods&quot;:[
         {
            &quot;index&quot;:1,
            &quot;mode&quot;:&quot;PREVIOUS_VERSION&quot;,
            &quot;date&quot;:&quot;2020-08-01T19:51:35+0000&quot;,
            &quot;parameter&quot;:&quot;20200801195129&quot;
         }
      ],
      &quot;ignoredConditions&quot;:false
   }
}
</code></pre>
<h4 id="5-4-2-jenkinslibtestsrcorgdevopssonarapigroovy">5-4-2 <code>JenkinslibTest/src/org/devops/sonarapi.groovy</code></h4>
<pre><code>package org.devops


//封装HTTP

def HttpReq(reqType,reqUrl,reqBody){
    def sonarServer = &quot;http://192.168.33.1:32314/api&quot;

    result = httpRequest authentication: 'sonar-admin-user',
            httpMode: reqType, 
            contentType: &quot;APPLICATION_JSON&quot;,
            consoleLogResponseBody: true,
            ignoreSslErrors: true, 
            requestBody: reqBody,
            url: &quot;${sonarServer}/${reqUrl}&quot;
            //quiet: true

    return result
}

//获取Sonar质量阈状态
def GetProjectStatus(projectName){
    apiUrl = &quot;project_branches/list?project=${projectName}&quot;
    response = HttpReq(&quot;GET&quot;,apiUrl,'')

    response = readJSON text: &quot;&quot;&quot;${response.content}&quot;&quot;&quot;
    result = response[&quot;branches&quot;][0][&quot;status&quot;][&quot;qualityGateStatus&quot;]

    //println(response)

   return result
}
</code></pre>
<h4 id="5-4-4-pipeline-sonar-api">5-4-4  <code>Pipeline</code> 调用<code>sonar api</code></h4>
<pre><code>#!groovy
@Library('jenkinslib@master') _

def build = new org.devops.buildtools()
def sonar = new org.devops.sonarqube()
def sonaradv = new org.devops.sonarqubeadv()
def sonarapi = new org.devops.sonarapi()

pipeline {
    agent { node { label &quot;hostmachine&quot; }}
    parameters {
        string(name: 'srcUrl', defaultValue: 'http://192.168.33.1:30088/root/demo-maven-service.git', description: '') 
        choice(name: 'branchName', choices: 'master\nstage\ndev', description: 'Please chose your branch')
        choice(name: 'buildType', choices: 'mvn', description: 'build tool')
        choice(name: 'buildShell', choices: 'clean package -DskipTest\n--version', description: 'build tool')
    }
    stages{
        stage('Checkout') {
            steps {
                script {
                    checkout([$class: 'GitSCM', branches: [[name: &quot;${branchName}&quot;]], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'gitlab-admin-user', url: &quot;${srcUrl}&quot;]]])
                } 
            }
        }

        stage('Build') {
            steps {
                script {
                    build.Build(buildType,buildShell)
                } 
            }
        }

        stage('Qa') {
            steps {
                script {
                    sonaradv.SonarScan(&quot;${JOB_NAME}&quot;,&quot;${JOB_NAME}&quot;,&quot;src&quot; )

                    result = sonarapi.GetProjectStatus(&quot;${JOB_NAME}&quot;)
                        println(result)
                    if(result.toString().contains(&quot;ERROR&quot;)){
                        error &quot;Qaulit gate failed, please re-check ur code!&quot;
                    }else{
                        println(result)
                    }
                } 
            }
        }    
    }
 }
 ```

 ```
script {
        sonaradv.SonarScan(&quot;${JOB_NAME}&quot;,&quot;${JOB_NAME}&quot;,&quot;src&quot; )

        result = sonarapi.GetProjectStatus(&quot;${JOB_NAME}&quot;)
            println(result)
        if(result.toString().contains(&quot;ERROR&quot;)){
            error &quot;Qaulit gate failed, please re-check ur code!&quot;
        }else{
            println(result)
        }
 } 
</code></pre>
<p><strong>Console Output</strong></p>
<pre><code>...
[Pipeline] httpRequest
HttpMethod: GET
URL: http://192.168.33.1:32314/api/project_branches/list?project=sq6scanner
Content-Type: application/json
Using authentication: sonar-admin-user
Sending request to url: http://192.168.33.1:32314/api/project_branches/list?project=sq6scanner
Response Code: HTTP/1.1 200 
Response: 
{&quot;branches&quot;:[{&quot;name&quot;:&quot;master&quot;,&quot;isMain&quot;:true,&quot;type&quot;:&quot;BRANCH&quot;,&quot;status&quot;:{&quot;qualityGateStatus&quot;:&quot;OK&quot;},&quot;analysisDate&quot;:&quot;2020-08-01T21:28:00+0000&quot;,&quot;excludedFromPurge&quot;:true}]}
Success code from [100‥399]
[Pipeline] readJSON
[Pipeline] echo
OK
[Pipeline] echo
OK
...
</code></pre>
<h2 id="6-sonarqube-api-way">6、 SonarQube 搜索与新建项目(API WAY)</h2>
<p><strong>http://192.168.33.1:32314/web_api/api</strong></p>
<h3 id="6-1">6-1 查找项目</h3>
<pre><code>api/projects/search?projects=${projectName}&quot; 
</code></pre>
<pre><code>//搜索Sonar项目
def SerarchProject(projectName){
    apiUrl = &quot;projects/search?projects=${projectName}&quot;
    response = HttpReq(&quot;GET&quot;,apiUrl,'')

    response = readJSON text: &quot;&quot;&quot;${response.content}&quot;&quot;&quot;
    result = response[&quot;paging&quot;][&quot;total&quot;]

    if(result.toString() == &quot;0&quot;){
       return &quot;false&quot;
    } else {
       return &quot;true&quot;
    }
}
</code></pre>
<h3 id="6-2">6-2 创建新项目</h3>
<pre><code>api/projects/create?name=${projectName} &amp;project=$ {projectName} &quot; 
</code></pre>
<pre><code>//创建Sonar项目
def CreateProject(projectName){
    apiUrl =  &quot;projects/create?name=${projectName}&amp;project=${projectName}&quot;
    response = HttpReq(&quot;POST&quot;,apiUrl,'')
    println(response)
}
</code></pre>
<h3 id="6-2-pipeline">6-2  搜索与新建项目在<code>Pipeline</code></h3>
<pre><code>stage('Qa') {
            steps {
                script {

                    result = sonarapi.SearchProject(&quot;${JOB_NAME}&quot;)
                    println(result)

                    if(result == &quot;false&quot;){
                       println(&quot;${JOB_NAME} ---- The project doesn't exist ----- ${JOB_NAME}!&quot;) 
                       sonarapi.CreateProject(&quot;${JOB_NAME}&quot;)
                    } else {
                       println(&quot;${JOB_NAME} ---- The project already exist!&quot;)
                    }

                    sonaradv.SonarScan(&quot;${JOB_NAME}&quot;,&quot;${JOB_NAME}&quot;,&quot;src&quot; )

                    result = sonarapi.GetProjectStatus(&quot;${JOB_NAME}&quot;)
                    println(result)

                    if(result.toString().contains(&quot;ERROR&quot;)){
                        error &quot;Quality gate failed, please re-check ur code!&quot;
                    }else{
                        println(result)
                    }
                } 
            }
        } 
</code></pre>
<pre><code> result = sonarapi.SearchProject(&quot;${JOB_NAME}&quot;)
                    println(result)

                    if(result == &quot;false&quot;){
                       println(&quot;${JOB_NAME} ---- The project doesn't exist ----- ${JOB_NAME}!&quot;) 
                       sonarapi.CreateProject(&quot;${JOB_NAME}&quot;)
                    } else {
                       println(&quot;${JOB_NAME} ---- The project already exist!&quot;)
                    }
</code></pre>
<p><strong>Console output</strong></p>
<pre><code>...
[Pipeline] { (Qa)
[Pipeline] script
[Pipeline] {
[Pipeline] httpRequest
HttpMethod: GET
URL: http://192.168.33.1:32314/api/projects/search?projects=sq7scanner
Content-Type: application/json
Using authentication: sonar-admin-user
Sending request to url: http://192.168.33.1:32314/api/projects/search?projects=sq7scanner
Response Code: HTTP/1.1 200 
Response: 
{&quot;paging&quot;:{&quot;pageIndex&quot;:1,&quot;pageSize&quot;:100,&quot;total&quot;:0},&quot;components&quot;:[]}
Success code from [100‥399]
[Pipeline] readJSON
[Pipeline] echo
false
[Pipeline] echo
sq7scanner ---- The project doesn't exist ----- sq7scanner!
[Pipeline] httpRequest
HttpMethod: POST
URL: http://192.168.33.1:32314/api/projects/create?name=sq7scanner&amp;project=sq7scanner
Content-Type: application/json
Using authentication: sonar-admin-user
Sending request to url: http://192.168.33.1:32314/api/projects/create?name=sq7scanner&amp;project=sq7scanner
Response Code: HTTP/1.1 200 
Response: 
{&quot;project&quot;:{&quot;key&quot;:&quot;sq7scanner&quot;,&quot;name&quot;:&quot;sq7scanner&quot;,&quot;qualifier&quot;:&quot;TRK&quot;,&quot;visibility&quot;:&quot;public&quot;}}
Success code from [100‥399]
[Pipeline] echo
Status: 200
[Pipeline] withSonarQubeEnv
Injecting SonarQube environment variables using the configuration: sonarqube
[Pipeline] {
[Pipeline] sh
+ date +%Y%m%d%H%M%S
...
</code></pre>
<p><img alt="Alt Image Text" src="../../images/chp8_4_28.png" title="Body image" /></p>
<h2 id="7">7 配置质量规则与质量阈</h2>
<h3 id="7-1">7-1 配置项目质量规则</h3>
<p><strong>确保质量阈已经被创建： java -&gt; demo</strong></p>
<p><img alt="Alt Image Text" src="../../images/chp8_4_18.png" title="Body image" /></p>
<pre><code>api/qualityprofiles/add_project?language=${language}&amp;qualityProfile=${qualityProfile}&amp;project=${projectName}&quot;
</code></pre>
<pre><code>//配置项目质量规则

def ConfigQualityProfiles(projectName,lang,qpname){
    apiUrl = &quot;qualityprofiles/add_project?language=${lang}&amp;project=${projectName}&amp;qualityProfile=${qpname}&quot;
    response = HttpReq(&quot;POST&quot;,apiUrl,'')
    println(response)
}
</code></pre>
<pre><code>stage('Qa') {
            steps {
                script {

                    result = sonarapi.SearchProject(&quot;${JOB_NAME}&quot;)
                    println(result)

                    if(result == &quot;false&quot;){
                       println(&quot;${JOB_NAME} ---- The project doesn't exist ----- ${JOB_NAME}!&quot;) 
                       sonarapi.CreateProject(&quot;${JOB_NAME}&quot;)
                    } else {
                       println(&quot;${JOB_NAME} ---- The project already exist!&quot;)
                    }

                    qpName = &quot;${JOB_NAME}&quot;.split(&quot;-&quot;)[0]
                    sonarapi.ConfigQualityProfiles(&quot;${JOB_NAME}&quot;,&quot;java&quot;,qpName)

                    sonaradv.SonarScan(&quot;${JOB_NAME}&quot;,&quot;${JOB_NAME}&quot;,&quot;src&quot; )

                    result = sonarapi.GetProjectStatus(&quot;${JOB_NAME}&quot;)
                    println(result)

                    if(result.toString().contains(&quot;ERROR&quot;)){
                        error &quot;Quality gate failed, please re-check ur code!&quot;
                    }else{
                        println(result)
                    }
                } 
            }
        }
</code></pre>
<p><img alt="Alt Image Text" src="../../images/chp8_4_29.png" title="Body image" /></p>
<pre><code>qpName = &quot;${JOB_NAME}&quot;.split(&quot;-&quot;)[0]
sonarapi.ConfigQualityProfiles(&quot;${JOB_NAME}&quot;,&quot;java&quot;,qpName)
</code></pre>
<ul>
<li>job name: <code>demo-sq8-scanner</code></li>
</ul>
<p><strong>console output</strong></p>
<pre><code>[Pipeline] httpRequest
HttpMethod: POST
URL: http://192.168.33.1:32314/api/qualityprofiles/add_project?language=java&amp;project=demo-sq8-scanner&amp;qualityProfile=demo
Content-Type: application/json
Using authentication: sonar-admin-user
Sending request to url: http://192.168.33.1:32314/api/qualityprofiles/add_project?language=java&amp;project=demo-sq8-scanner&amp;qualityProfile=demo
Response Code: HTTP/1.1 204 
Response: 
null
Success code from [100‥399]
[Pipeline] echo
Status: 204
</code></pre>
<p><img alt="Alt Image Text" src="../../images/chp8_4_30.png" title="Body image" /></p>
<h3 id="7-2">7-2 配置项目质量阈</h3>
<pre><code>//项目授权
api/permissions/apply_template?projectKey=${projecttKey}&amp;templateName=${templateName}&quot; 

//获取质量阈ID
api/qualitygates/show?name=${gateName}

//更新质量阈值
api/qualitygates/select?projectKey=${projectKey}&amp;gateId=${gateId}&quot; 
</code></pre>
<p><strong><code>JenkinslibTest/src/org/devops/sonarqube.groovy</code></strong></p>
<pre><code>//获取质量阈ID
def GetQualtyGateId(gateName){
    apiUrl= &quot;qualitygates/show?name=${gateName}&quot;
    response = HttpReq(&quot;GET&quot;,apiUrl,'')
    response = readJSON text: &quot;&quot;&quot;${response.content}&quot;&quot;&quot;
    result = response[&quot;id&quot;]

    return result
}

//配置项目质量阈

def ConfigQualityGates(projectName,gateName){
    gateId = GetQualtyGateId(gateName)
    apiUrl = &quot;qualitygates/select?gateId=${gateId}&amp;projectKey=${projectName}&quot;
    response = HttpReq(&quot;POST&quot;,apiUrl,'')
    println(response)println(response)
}
</code></pre>
<pre><code>sonarapi.ConfigQualityGates(&quot;${JOB_NAME}&quot;,qpName)
</code></pre>
<p><img alt="Alt Image Text" src="../../images/chp8_4_31.png" title="Body image" /></p>
<h3 id="7-3-default-qualitygatesdefault-qualityfiles">7-3 使用<code>default QualityGates</code>或者<code>default Qualityfiles</code></h3>
<pre><code>sonarapi.ConfigQualityProfiles(&quot;${JOB_NAME}&quot;,&quot;java&quot;,&quot;Sonar%20way&quot;)
</code></pre>
<h3 id="7-4-sharedlib-and-pipeline">7-4 最终版本(sharedlib and pipeline)</h3>
<p><strong><code>JenkinslibTest/src/org/devops/sonarapi.groovy</code></strong></p>
<pre><code>package org.devops


//封装HTTP

def HttpReq(reqType,reqUrl,reqBody){
    def sonarServer = &quot;http://192.168.33.1:32314/api&quot;

    result = httpRequest authentication: 'sonar-admin-user',
            httpMode: reqType, 
            contentType: &quot;APPLICATION_JSON&quot;,
            consoleLogResponseBody: true,
            ignoreSslErrors: true, 
            requestBody: reqBody,
            url: &quot;${sonarServer}/${reqUrl}&quot;
            //quiet: true

    return result
}


//获取Sonar质量阈状态
def GetProjectStatus(projectName){
    apiUrl = &quot;project_branches/list?project=${projectName}&quot;
    response = HttpReq(&quot;GET&quot;,apiUrl,'')

    response = readJSON text: &quot;&quot;&quot;${response.content}&quot;&quot;&quot;
    result = response[&quot;branches&quot;][0][&quot;status&quot;][&quot;qualityGateStatus&quot;]

    //println(response)

   return result
}

//获取Sonar质量阈状态(多分支)
def GetProjectStatus(projectName,branchName){
    apiUrl = &quot;qualitygates/project_status?projectKey=${projectName}&amp;branch=${branchName}&quot;
    response = HttpReq(&quot;GET&quot;,apiUrl,'')

    response = readJSON text: &quot;&quot;&quot;${response.content}&quot;&quot;&quot;
    result = response[&quot;projectStatus&quot;][&quot;status&quot;]

    //println(response)

   return result
}

//搜索Sonar项目
def SearchProject(projectName){
    apiUrl = &quot;projects/search?projects=${projectName}&quot;
    response = HttpReq(&quot;GET&quot;,apiUrl,'')

    response = readJSON text: &quot;&quot;&quot;${response.content}&quot;&quot;&quot;
    result = response[&quot;paging&quot;][&quot;total&quot;]

    if(result.toString() == &quot;0&quot;){
       return &quot;false&quot;
    } else {
       return &quot;true&quot;
    }
}

//创建Sonar项目
def CreateProject(projectName){
    apiUrl =  &quot;projects/create?name=${projectName}&amp;project=${projectName}&quot;
    response = HttpReq(&quot;POST&quot;,apiUrl,'')
    println(response)
}

//配置项目质量规则

def ConfigQualityProfiles(projectName,lang,qpname){
    apiUrl = &quot;qualityprofiles/add_project?language=${lang}&amp;project=${projectName}&amp;qualityProfile=${qpname}&quot;
    response = HttpReq(&quot;POST&quot;,apiUrl,'')
    println(response)
}


//获取质量阈ID
def GetQualtyGateId(gateName){
    apiUrl= &quot;qualitygates/show?name=${gateName}&quot;
    response = HttpReq(&quot;GET&quot;,apiUrl,'')
    response = readJSON text: &quot;&quot;&quot;${response.content}&quot;&quot;&quot;
    result = response[&quot;id&quot;]

    return result
}

//配置项目质量阈

def ConfigQualityGates(projectName,gateName){
    gateId = GetQualtyGateId(gateName)
    apiUrl = &quot;qualitygates/select?gateId=${gateId}&amp;projectKey=${projectName}&quot;
    response = HttpReq(&quot;POST&quot;,apiUrl,'')
    println(response)println(response)
}
</code></pre>
<p><strong>pipeline</strong></p>
<pre><code>#!groovy
@Library('jenkinslib@master') _

def build = new org.devops.buildtools()
def sonar = new org.devops.sonarqube()
def sonaradv = new org.devops.sonarqubeadv()
def sonarapi = new org.devops.sonarapi()

pipeline {
    agent { node { label &quot;hostmachine&quot; }}
    parameters {
        string(name: 'srcUrl', defaultValue: 'http://192.168.33.1:30088/root/demo-maven-service.git', description: '') 
        choice(name: 'branchName', choices: 'master\nstage\ndev', description: 'Please chose your branch')
        choice(name: 'buildType', choices: 'mvn', description: 'build tool')
        choice(name: 'buildShell', choices: 'clean package -DskipTest\n--version', description: 'build tool')
    }
    stages{
        stage('Checkout') {
            steps {
                script {
                    checkout([$class: 'GitSCM', branches: [[name: &quot;${branchName}&quot;]], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'gitlab-admin-user', url: &quot;${srcUrl}&quot;]]])
                } 
            }
        }

        stage('Build') {
            steps {
                script {
                    build.Build(buildType,buildShell)
                } 
            }
        }

        stage('Qa') {
            steps {
                script {

                    result = sonarapi.SearchProject(&quot;${JOB_NAME}&quot;)
                    println(result)

                    if(result == &quot;false&quot;){
                       println(&quot;${JOB_NAME} ---- The project doesn't exist ----- ${JOB_NAME}!&quot;) 
                       sonarapi.CreateProject(&quot;${JOB_NAME}&quot;)
                    } else {
                       println(&quot;${JOB_NAME} ---- The project already exist!&quot;)
                    }

                    qpName = &quot;${JOB_NAME}&quot;.split(&quot;-&quot;)[0]
                    sonarapi.ConfigQualityProfiles(&quot;${JOB_NAME}&quot;,&quot;java&quot;,qpName)

                    sonarapi.ConfigQualityGates(&quot;${JOB_NAME}&quot;,qpName)

                    sonaradv.SonarScan(&quot;${JOB_NAME}&quot;,&quot;${JOB_NAME}&quot;,&quot;src&quot; )

                    result = sonarapi.GetProjectStatus(&quot;${JOB_NAME}&quot;)
                    println(result)

                    if(result.toString().contains(&quot;ERROR&quot;)){
                        error &quot;Quality gate failed, please re-check ur code!&quot;
                    }else{
                        println(result)
                    }
                } 
            }
        }    
    }
 }
</code></pre>
<p><img alt="Alt Image Text" src="../../images/chp8_4_32.png" title="Body image" /></p>
<h2 id="8-sonar">8 Sonar 配置项目多分支模式</h2>
<p>https://github.com/mc1arke/sonarqube-community-branch-plugin</p>
<ul>
<li>
<p>将插件放到两个目录中，然后重启sonar</p>
<ul>
<li><code>/opt/sonarqube/extensions/plugins</code></li>
<li><code>/opt/sonarqube/lib/common</code></li>
</ul>
</li>
<li>
<p>扫描添加 <code>--define sonar.branch.name=${branchName}-X</code></p>
</li>
</ul>
<p><img alt="Alt Image Text" src="../../images/chp8_4_33.png" title="Body image" /></p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2016-2020 Jacob Xi
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.b425cdc4.min.js"></script>
      
    
  </body>
</html>