
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Jacob's 手摸手Jenkins实用教程">
      
      
        <meta name="author" content="Jacob Xi">
      
      
      
        <link rel="prev" href="../1k8s_install/">
      
      
        <link rel="next" href="../../chap13/1jmeter/">
      
      <link rel="icon" href="../../images/logo.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.17">
    
    
      
        <title>使用 Jenkins Pipeline 流水线部署 Kubernetes 应用 - Jacob Jenkins Books</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.26e3688c.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="deep-purple">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#jenkins-pipeline-kubernetes" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="Jacob Jenkins Books" class="md-header__button md-logo" aria-label="Jacob Jenkins Books" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Jacob Jenkins Books
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              使用 Jenkins Pipeline 流水线部署 Kubernetes 应用
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Chao-Xi/jxjenkinsbook.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxjenkinsbook
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Jacob Jenkins Books" class="md-nav__button md-logo" aria-label="Jacob Jenkins Books" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    Jacob Jenkins Books
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Chao-Xi/jxjenkinsbook.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxjenkinsbook
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Welcome
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          一、Jenkins 运维管理
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          一、Jenkins 运维管理
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../jk_chapter1/" class="md-nav__link">
        第一节 Jenkins 运维管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../jk_chapter1_2/" class="md-nav__link">
        第二节 分布式构建与并行构建
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../jk_chapter1_3/" class="md-nav__link">
        第三节 可视化构建试图
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/1active_parameter/" class="md-nav__link">
        第四节 使用Active Choice Parameter参数化构建
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/2python-jenkins/" class="md-nav__link">
        第五节 自动化使用python-jenkins管理Jenkins
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          二、Jenkins 流水线基础
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          二、Jenkins 流水线基础
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/1chap2_Jenkinsfile/" class="md-nav__link">
        第一节 编写 Jenkinsfile 运行流水线
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/2chap2_declarative_pipeline/" class="md-nav__link">
        第二节 声明式流水线语法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/3chap2_script_pipeline/" class="md-nav__link">
        第三节 脚本化Pipeline
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/4chap2_sharedlib/" class="md-nav__link">
        第四节 Pipeline 扩展——共享库
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/5chap2_quick_jenkinsfile/" class="md-nav__link">
        第五节 如何快速上手Jenkinsfile编写
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/6chap2_pipe_vs_dec/" class="md-nav__link">
        第六节 脚本式管道与声明式管道-四个实际差异
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/7chap2_jenkins_git/" class="md-nav__link">
        第七节 使用Jenkins Git参数实现分支标签动态选择
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/8Jenkinsfile_pipeline_multibranch/" class="md-nav__link">
        第八节 多分支类型管道- 基于Jenkinsfile自动创建Pipeline(2023)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/9jenkins_parallel2023/" class="md-nav__link">
        第九节 实践-Jenkins 声明式管道中的动态并行阶段
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/10mc_parallel/" class="md-nav__link">
        第十节 微服务模式下如何实现多模块并行构建发布
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          三、Groovy 基础
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          三、Groovy 基础
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/1chap3_groovy_basic/" class="md-nav__link">
        第一节 Groovy 简明教程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/2chap3_groovy_basic2/" class="md-nav__link">
        第二节 Groovy 基础
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          四、构建工具集成
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          四、构建工具集成
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/1chp4_tools1/" class="md-nav__link">
        第一节 构建工具集成
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/2chp4_tools2/" class="md-nav__link">
        第二节 集成 SaltStack 部署工具
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/3chp4_tools3/" class="md-nav__link">
        第三节 Jenkins集成Ansibe实现自动化部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/4chp4_tools4/" class="md-nav__link">
        第四节 Jenkins集成Ansibe实战手册 - BB Mobile（2018）
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          五、凭证管理
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          五、凭证管理
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/5jenkins_secrets/" class="md-nav__link">
        0 如何在 Jenkins 中安全管理 Secrets
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/1chap5_cred1/" class="md-nav__link">
        第一节 凭证管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/2chap5_vault/" class="md-nav__link">
        第二节 凭证管理使用HashiCorp Vault
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/3docker_valut/" class="md-nav__link">
        第二节(Extra) - Store Secrets using Hashicorp Vault with Docker
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/4docker_mask/" class="md-nav__link">
        第三节 在Jenkins日志中隐藏敏感信息
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
      
      
      
        <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
          六、用户认证集成
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          六、用户认证集成
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/1chap6_ldap/" class="md-nav__link">
        第一节 Ldap 用户认证集成
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/2chap6_gitlab/" class="md-nav__link">
        第二节 Jenkins集成 Gitlab SSO 单点登录
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/3chap6_github/" class="md-nav__link">
        第三节 Jenkins集成 Github SSO 单点登录
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
      
      
      
        <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
          七、Gitlab 版本控制系统集成
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          七、Gitlab 版本控制系统集成
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/1chap7_gitlab_connect/" class="md-nav__link">
        第一节 Gitlab – Jenkins Integration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/2chap7_gitlab_pipeline/" class="md-nav__link">
        第二节 Gitlab-Jenkins 版本控制
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/3chap7_gitlab_pipeline_extra/" class="md-nav__link">
        第三节 Gitlab-Jenkins 版本控制（补充）
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/4gitops_cicd/" class="md-nav__link">
        ​第四节 GitOps Gitlab-Jenkins 模式下微服务CI/CD实践
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
      
      
      
        <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
          八、代码质量平台集成
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          八、代码质量平台集成
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/1chap8_code_quality/" class="md-nav__link">
        第一节 代码质量
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/2chap8_code_quality_sonarqube/" class="md-nav__link">
        第二节 SonarQube：持续代码质量检查
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/3chap8_code_quality_allure/" class="md-nav__link">
        第三节 Allure测试报告：更美观的测试报告
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/4chap8_code_quality_integration/" class="md-nav__link">
        第四季 代码质量平台集成(SonarQube Final Edition)
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
      
      
      
        <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
          九、制品库集成
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          九、制品库集成
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/chap9_artifact0/" class="md-nav__link">
        第一节 Sonatype Nexus 基本介绍与安装
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/chap9_artifact1/" class="md-nav__link">
        第二节 制品管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/chap9_artifact2/" class="md-nav__link">
        第三节 Nexus 制品上传
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/chap9_artifact3/" class="md-nav__link">
        第四节 Jenkins & Jfrog Artifactory
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/chap9_5nexus_2023/" class="md-nav__link">
        第五节 Jenkins流水线将制品发布到Nexus存储库
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
      
      
      
        <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
          十、需求管理工具集成
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_11">
          <span class="md-nav__icon md-icon"></span>
          十、需求管理工具集成
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap10/1chap10_jira_install/" class="md-nav__link">
        第一节 k8s 安装本地 Jira 服务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap10/2chap10_jira_gilab/" class="md-nav__link">
        第二节 Jenkins 配置端到端流水线（Jira和Gitlab的集成）
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" >
      
      
      
        <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="0">
          十一、Docker 集成
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_12">
          <span class="md-nav__icon md-icon"></span>
          十一、Docker 集成
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap11/1Docker_agents/" class="md-nav__link">
        第一节 基于 Docker 配置构建资源池
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap11/2Docker_pipeline/" class="md-nav__link">
        第二节 基于Docker的pipeline流水线
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap11/3Docker_registry/" class="md-nav__link">
        第三节 构建应用镜像到镜像仓库管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap11/4Docker_groovy/" class="md-nav__link">
        第四节 使用Groovy代码初始化Docker配置
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" checked>
      
      
      
        <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
          十二、K8S 平台集成
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_13">
          <span class="md-nav__icon md-icon"></span>
          十二、K8S 平台集成
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../1k8s_install/" class="md-nav__link">
        K8S 平台集成(全)
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          使用 Jenkins Pipeline 流水线部署 Kubernetes 应用
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        使用 Jenkins Pipeline 流水线部署 Kubernetes 应用
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1jenkins-pipeline" class="md-nav__link">
    1、Jenkins Pipeline 有几个核心概念
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-slave" class="md-nav__link">
    2、在 Slave 中构建任务
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-kubernetes" class="md-nav__link">
    3、部署 Kubernetes 应用
  </a>
  
    <nav class="md-nav" aria-label="3、部署 Kubernetes 应用">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pipeline" class="md-nav__link">
    Pipeline
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_14" >
      
      
      
        <label class="md-nav__link" for="__nav_14" id="__nav_14_label" tabindex="0">
          十三、自动化接口测试
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_14_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_14">
          <span class="md-nav__icon md-icon"></span>
          十三、自动化接口测试
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap13/1jmeter/" class="md-nav__link">
        第一节 Jmeter & Ant 自动化测试
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap13/2jenkins_jmeter/" class="md-nav__link">
        第二节 Jenkins、Ant、Jmeter 自动化测试
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_15" >
      
      
      
        <label class="md-nav__link" for="__nav_15" id="__nav_15_label" tabindex="0">
          十四、流水线最佳实践
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_15_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_15">
          <span class="md-nav__icon md-icon"></span>
          十四、流水线最佳实践
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap14/1JIRA_JEN_K8S/" class="md-nav__link">
        第一节 基于Jira端到端流水线的最佳实践
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap14/2JEN_K8S_API/" class="md-nav__link">
        第二节 Jenkins K8S Gitlab 集成
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap14/3Jen_k8s_pipeline/" class="md-nav__link">
        第三节 Jenkins + K8S + Gitlab 构建 RLEASE 打包发布更新流水线到K8S集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap14/4Jen_update_deploy_pip/" class="md-nav__link">
        第四节 版本晋级及发布流水线
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap14/5back_front_pipeline/" class="md-nav__link">
        第五节 前端后端项目发布流水线（Java+Nodejs)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap14/6Android_pipeline/" class="md-nav__link">
        第六节 构建Android项目流水线
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap14/7Jenkins_azure_mern/" class="md-nav__link">
        第七节 基于Azure部署Jenkins服务并开发MERN应用的CI/CD构建管道
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap14/2TMF_JENKINS/" class="md-nav__link">
        第八节 基础设施即代码 - 使用Terraform创建AWS EC2实例并部署Jenkins服务
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_16" >
      
      
      
        <label class="md-nav__link" for="__nav_16" id="__nav_16_label" tabindex="0">
          十五、监控与API调用
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_16_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_16">
          <span class="md-nav__icon md-icon"></span>
          十五、监控与API调用
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap15/1Jenkins_Prometheus/" class="md-nav__link">
        第一节 使用 Prometheus 监控 Jenkins
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap15/2Jenkins_InfluxDB_Grafana/" class="md-nav__link">
        第二节 Jenkins+InfluxDB+Grafana 收集构建数据
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap15/3Jenkins_python_API/" class="md-nav__link">
        第三节 Jenkins Python API 实践
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap15/4Jenkins_REST_API/" class="md-nav__link">
        第四节 Jenkins REST API 使用实践
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap15/5Jenkins_DSL/" class="md-nav__link">
        第五节 Jenkins Core Api & Job DSL创建项目
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_17" >
      
      
      
        <label class="md-nav__link" for="__nav_17" id="__nav_17_label" tabindex="0">
          十六、持续交付理论分析
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_17_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_17">
          <span class="md-nav__icon md-icon"></span>
          十六、持续交付理论分析
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap16/1cd_intro/" class="md-nav__link">
        L1 量身定制你的持续交付体系
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap16/2config_mgt/" class="md-nav__link">
        L2 配置管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap16/3Env_mgt/" class="md-nav__link">
        L3 环境管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap16/4const_mgt/" class="md-nav__link">
        L4 构建集成
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap16/5Mon_mgt/" class="md-nav__link">
        L5 发布及监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap16/6Test_mgt/" class="md-nav__link">
        L6 测试管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap16/7CD_pla/" class="md-nav__link">
        L7 持续交付平台化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap16/8Real_exp/" class="md-nav__link">
        L8 实践案例
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap16/9cicd_rev/" class="md-nav__link">
        L9 持续交付理论总结及面试
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_18" >
      
      
      
        <label class="md-nav__link" for="__nav_18" id="__nav_18_label" tabindex="0">
          Extra 知识扩展
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_18_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_18">
          <span class="md-nav__icon md-icon"></span>
          Extra 知识扩展
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Mkdocs_github_travis/" class="md-nav__link">
        GitHub+Travis+Mkdocs自动化构建文档库
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1jenkins-pipeline" class="md-nav__link">
    1、Jenkins Pipeline 有几个核心概念
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-slave" class="md-nav__link">
    2、在 Slave 中构建任务
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-kubernetes" class="md-nav__link">
    3、部署 Kubernetes 应用
  </a>
  
    <nav class="md-nav" aria-label="3、部署 Kubernetes 应用">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pipeline" class="md-nav__link">
    Pipeline
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="jenkins-pipeline-kubernetes"><strong>使用 Jenkins Pipeline 流水线部署 Kubernetes 应用</strong></h1>
<p>要实现在 Jenkins 中的构建工作，可以有多种方式，我们这里采用比较常用的 Pipeline 这种方式。Pipeline，简单来说，就是一套运行在 Jenkins 上的工作流框架，将原来独立运行于单个或者多个节点的任务连接起来，实现单个任务难以完成的复杂流程编排和可视化的工作。</p>
<h2 id="1jenkins-pipeline"><strong>1、Jenkins Pipeline 有几个核心概念</strong></h2>
<ul>
<li>Node：节点，<strong>一个 Node 就是一个 Jenkins 节点，Master 或者 Agent</strong>，是执行 Step 的具体运行环境，比如我们之前动态运行的 Jenkins Slave 就是一个 Node 节点</li>
<li>Stage：阶段，<strong>一个 Pipeline 可以划分为若干个 Stage，每个 Stage 代表一组操作，比如：Build、Test、Deploy，Stage 是一个逻辑分组的概念，可以跨多个 Node</strong></li>
<li>Step：步骤，Step 是最基本的操作单元，可以是打印一句话，也可以是构建一个 Docker 镜像，由各类 Jenkins 插件提供，比如命令：<code>sh 'make'</code>，就相当于我们平时 shell 终端中执行 make 命令一样。</li>
</ul>
<p><strong>那么我们如何创建 Jenkins Pipline 呢？</strong></p>
<ul>
<li>Pipeline 脚本是由 Groovy 语言实现的，但是我们没必要单独去学习 Groovy，当然你会的话最好</li>
<li><strong>Pipeline 支持两种语法：Declarative(声明式)和 Scripted Pipeline(脚本式)语法</strong></li>
<li>Pipeline 也有两种创建方法：可以直接在 Jenkins 的 Web UI 界面中输入脚本；也可以通过创建一个 Jenkinsfile 脚本文件放入项目源码库中</li>
<li><strong>一般我们都推荐在 Jenkins 中直接从源代码控制(SCMD)中直接载入 Jenkinsfile Pipeline 这种方法</strong></li>
</ul>
<p>我们这里来给大家快速创建一个简单的 Pipeline，直接在 Jenkins 的 Web UI 界面中输入脚本运行。</p>
<ul>
<li>新建任务：在 Web UI 中点击 新建任务 -&gt; 输入名称：<code>pipeline-demo</code> -&gt; 选择下面的 流水线 -&gt; 点击 确定</li>
<li>配置：在最下方的 Pipeline 区域输入如下 Script 脚本，然后点击保存。</li>
</ul>
<pre><code>
node {
  stage('Clone') {
      echo &quot;1.Clone Stage&quot;
  }
  stage('Test') {
      echo &quot;2.Test Stage&quot;
  }
  stage('Build') {
      echo &quot;3.Build Stage&quot;
  }
  stage('Deploy') {
      echo &quot;4. Deploy Stage&quot;
  }
}
</code></pre>
<ul>
<li>构建：点击左侧区域的 立即构建，可以看到 Job 开始构建了</li>
</ul>
<p>隔一会儿，构建完成，可以点击左侧区域的 <code>Console Output</code>，我们就可以看到如下输出信息：</p>
<p><img alt="Alt Image Text" src="../../images/chp12_2_1.png" title="body image" /></p>
<p>console output 我们可以看到上面我们 Pipeline 脚本中的4条输出语句都打印出来了，证明是符合我们的预期的。</p>
<p>如果大家对 Pipeline 语法不是特别熟悉的，可以前往输入脚本的下面的链接 流水线语法 中进行查看，这里有很多关于 Pipeline 语法的介绍，也可以自动帮我们生成一些脚本。</p>
<h2 id="2-slave"><strong>2、在 Slave 中构建任务</strong></h2>
<p>上面我们创建了一个简单的 Pipeline 任务，但是我们可以看到这个任务并没有在 Jenkins 的 Slave 中运行，那么如何让我们的任务跑在 Slave 中呢？</p>
<p>还记得上节课我们在添加 Slave Pod 的时候，一定要记住添加的 label 吗？</p>
<p>没错，我们就需要用到这个 label，我们重新编辑上面创建的 Pipeline 脚本，给 node 添加一个 label 属性，如下：</p>
<pre><code>node('jxi-agent') {
  stage('Clone') {
    echo &quot;1.Clone Stage&quot;
  }
  stage('Test') {
    echo &quot;2.Test Stage&quot;
  }
  stage('Build') {
    echo &quot;3.Build Stage&quot;
  }
  stage('Deploy') {
    echo &quot;4. Deploy Stage&quot;
  }
}
</code></pre>
<p>我们这里只是给 node 添加了一个 jxi-agent 这样的一个 label，然后我们保存，构建之前查看下 kubernetes 集群中的 Pod：</p>
<pre><code>$ kubectl get pods -n kube-ops
NAME                                           READY   STATUS    RESTARTS   AGE
jenkins-587b78f5cd-47hf8                       1/1     Running   2          4d21h
......
</code></pre>
<p>然后重新触发立刻构建：</p>
<pre><code>$ kubectl get pods -n kube-ops
NAME                                           READY   STATUS    RESTARTS   AGE
jenkins-587b78f5cd-47hf8                       1/1     Running   2          4d21h
jenkins-agent-6gw0w                            1/1     Running   0          4s
</code></pre>
<p>我们发现多了一个名叫 <code>jenkins-agent-6gw0w</code> 的 <code>Pod</code>正在运行，隔一会儿这个 Pod 就不再了。这也证明我们的 Job 构建完成了，同样回到 Jenkins 的 Web UI 界面中查看 Console Output，可以看到如下的信息：</p>
<p><img alt="Alt Image Text" src="../../images/chp12_2_2.png" title="body image" /></p>
<p><code>pipeline demo#2</code> 是不是也证明我们当前的任务在跑在上面动态生成的这个 Pod 中，也符合我们的预期。我们回到 Job 的主界面，也可以看到大家可能比较熟悉的 阶段视图 界面：</p>
<p><img alt="Alt Image Text" src="../../images/chp12_2_3.png" title="body image" /></p>
<h2 id="3-kubernetes"><strong>3、部署 Kubernetes 应用</strong></h2>
<p>上面我们已经知道了如何在 Jenkins Slave 中构建任务了，那么如何来部署一个原生的 Kubernetes 应用呢？要部署 Kubernetes 应用，我们就得对我们之前部署应用的流程要非常熟悉才行，我们之前的流程是怎样的：</p>
<ul>
<li>编写代码</li>
<li>测试</li>
<li>编写 Dockerfile</li>
<li>构建打包 Docker 镜像</li>
<li>推送 Docker 镜像到仓库</li>
<li>编写 Kubernetes YAML 文件</li>
<li>更改 YAML 文件中 Docker 镜像 TAG</li>
<li>利用 kubectl 工具部署应用</li>
</ul>
<p>我们之前在 Kubernetes 环境中部署一个原生应用的流程应该基本上是上面这些流程吧？</p>
<p>现在我们就需要把上面这些流程放入 Jenkins 中来自动帮我们完成(当然编码除外)，从测试到更新 YAML 文件属于 CI 流程，后面部署属于 CD 的流程。如果按照我们上面的示例，我们现在要来编写一个 Pipeline 的脚本，应该怎么编写呢？</p>
<pre><code>node('jxi-agent') {
    stage('Clone') {
      echo &quot;1.Clone Stage&quot;
    }
    stage('Test') {
      echo &quot;2.Test Stage&quot;
    }
    stage('Build') {
      echo &quot;3.Build Docker Image Stage&quot;
    }
    stage('Push') {
      echo &quot;4.Push Docker Image Stage&quot;
    }
    stage('YAML') {
      echo &quot;5.Change YAML File Stage&quot;
    }
    stage('Deploy') {
      echo &quot;6.Deploy Stage&quot;
    }
}
</code></pre>
<p>现在我们创建一个流水线的作业，直接使用上面的脚本来构建，同样可以得到正确的结果：</p>
<p><img alt="Alt Image Text" src="../../images/chp12_2_4.png" title="body image" /></p>
<p>这里我们来将一个简单 golang 程序，部署到 kubernetes 环境中，代码链接：<a href="https://github.com/cnych/drone-k8s-demo">https://github.com/cnych/drone-k8s-demo</a>。</p>
<p>我们将代码推送到我们自己的 GitLab 仓库上去，地址：<a href="http://git.k8s.local/course/devops-demo">http://git.k8s.local/course/devops-demo</a>，这样让 Jenkins 和 Gitlab 去进行连接进行 CI/CD。</p>
<p>如果按照之前的示例，我们是不是应该像这样来编写 Pipeline 脚本：</p>
<ul>
<li>第一步，clone 代码 </li>
<li>第二步，进行测试，如果测试通过了才继续下面的任务 </li>
<li>第三步，由于 Dockerfile 基本上都是放入源码中进行管理的，所以我们这里就是直接构建 Docker 镜像了 </li>
<li>第四步，镜像打包完成，就应该推送到镜像仓库中吧 </li>
<li>第五步，镜像推送完成，是不是需要更改 YAML 文件中的镜像 TAG 为这次镜像的 TAG </li>
<li>第六步，万事俱备，只差最后一步，使用 kubectl 命令行工具进行部署了</li>
</ul>
<p>到这里我们的整个 CI/CD 的流程是不是就都完成了。</p>
<p>我们同样可以用上面的我们自定义的一个 jnlp 的镜像来完成我们的整个构建工作，但是我们这里的项目是 golang 代码的，构建需要相应的环境，如果每次需要特定的环境都需要重新去定制下镜像这未免太麻烦了，我们这里来采用一种更加灵活的方式，<strong>自定义 podTemplate</strong>。</p>
<p><strong>我们可以直接在 Pipeline 中去自定义 Slave Pod 中所需要用到的容器模板，这样我们需要什么镜像只需要在 Slave Pod Template 中声明即可，完全不需要去定义一个庞大的 Slave 镜像了</strong>。</p>
<p>这里我们需要使用到 gitlab 的插件，用于 Gitab 侧代码变动后触发 Jenkins 的构建任务：</p>
<p><img alt="Alt Image Text" src="../../images/chp12_2_5.png" title="body image" /></p>
<p>然后新建一个名为 <code>devops-demo</code> 类型为流水线的任务，在 构建触发器 区域选择 Build when a change is pushed to GitLab，后面的 <a href="http://jenkins.k8s.local/project/devops-demo">http://jenkins.k8s.local/project/devops-demo</a> 是我们需要在 Gitlab 上配的 Webhook 地址:</p>
<p><img alt="Alt Image Text" src="../../images/chp12_2_6.png" title="body image" /></p>
<p>其中<strong>Comment (regex) for triggering a build</strong>是说在 git 仓库，发送包含 <code>jenkins build</code> 这样的关键字的时候会触发执行此 build 构建。</p>
<p>然后点击下面的高级可以生成 <code>token</code>。</p>
<p><strong>这里的 url 和 token 是 jenkins 的 api</strong>，可以提供给 GtiLab 使用，在代码合并/提交<code>commit/push</code>代码等操作时，通知 Jenkins 执行 build 操作。</p>
<p><img alt="Alt Image Text" src="../../images/chp12_2_7.png" title="body image" /></p>
<blockquote>
<p>注: 复制出 URL 和 Token，我们后面配置 Gitlab 的 Webhook 会用到。</p>
</blockquote>
<p>然后在下面的流水线区域我们可以选择 Pipeline script 然后在下面测试流水线脚本，我们这里选择 <code>Pipeline script from SCM</code>，意思就是从代码仓库中通过 Jenkinsfile 文件获取 Pipeline script 脚本定义，然后选择 SCM 来源为 Git，在出现的列表中配置上仓库地址 <a href="http://git.k8s.local/course/devops-demo.git]">http://git.k8s.local/course/devops-demo.git</a>，由于我们是在一个 Slave Pod 中去进行构建，所以如果使用 SSH 的方式去访问 Gitlab 代码仓库的话就需要频繁的去更新 SSH-KEY，所以我们这里采用直接使用用户名和密码的形式来方式：</p>
<p><img alt="Alt Image Text" src="../../images/chp12_2_8.png" title="body image" /></p>
<p><strong>我们可以看到有一个明显的错误 <code>Could not resolve host: git.k8s.local</code>提示不能解析我们的 <code>GitLab</code> 域名，这是因为我们的域名都是自定义的，我们可以通过在 CoreDNS 中添加自定义域名解析来解决这个问题（如果你的域名是外网可以正常解析的就不会出现这个问题了）</strong>：</p>
<pre><code>$ kubectl edit cm coredns -n kube-system
apiVersion: v1
data:
  Corefile: |
    .:53 {
        log
        errors
        health {
          lameduck 5s
        }
        ready
        hosts {  # 添加自定义域名解析
          192.168.31.30 git.k8s.local
          192.168.31.30 jenkins.k8s.local
          192.168.31.30 harbor.k8s.local
          fallthrough
        }
        kubernetes cluster.local in-addr.arpa ip6.arpa {
           pods insecure
           upstream
           fallthrough in-addr.arpa ip6.arpa
        }
        prometheus :9153
        forward . /etc/resolv.conf
        cache 30
        loop
        reload
        loadbalance
    }
kind: ConfigMap
......
</code></pre>
<p>修改完成后，隔一小会儿，CoreDNS 就会自动热加载，我们就可以在集群内访问我们自定义的域名了。然后肯定没有权限，所以需要配置帐号认证信息。</p>
<p><img alt="Alt Image Text" src="../../images/chp12_2_9.png" title="body image" /></p>
<p><strong>在 <code>Credentials</code> 区域点击添加按钮添加我们访问 Gitlab 的用户名和密码</strong>：</p>
<p><img alt="Alt Image Text" src="../../images/chp12_2_10.png" title="body image" /></p>
<p>然后需要我们配置用于构建的分支，如果所有的分支我们都想要进行构建的话，只需要将 Branch Specifier 区域留空即可，一般情况下不同的环境对应的分支才需要构建，比如 master、dev、test 等，平时开发的 feature 或者 bugfix 的分支没必要频繁构建，我们这里就只配置 master 个分支用于构建。</p>
<p>最后点击保存，至此，Jenkins 的持续集成配置好了，还需要配置 Gitlab 的 Webhook，用于代码提交通知 Jenkins。前往 Gitlab 中配置项目 <code>devops-demo</code> 的 <code>Webhook</code>，<code>settings -&gt; Webhooks</code>，填写上面得到的 trigger 地址：</p>
<p><img alt="Alt Image Text" src="../../images/chp12_2_11.png" title="body image" /></p>
<p>我们这里都是自定义的域名，也没有配置 https 服务，所以记得取消配置下面的 <strong>启用SSL验证</strong>。</p>
<p>保存后，如果出现 <code>Urlis blocked: Requests to the local network are not allowed</code> 这样的报警信息，<strong>则需要进入 GitLab Admin -&gt; 设置 -&gt; 网络 -&gt; 勾选 外发请求，然后保存配置</strong>。</p>
<p><img alt="Alt Image Text" src="../../images/chp12_2_12.png" title="body image" /></p>
<p>现在就可以正常保存了，可以直接点击 <strong>测试 -&gt; Push Event</strong> 测试是否可以正常访问 Webhook 地址，出现了 <strong>Hook executed successfully: HTTP 200</strong> 则证明 Webhook 配置成功了，否则就需要检查下 Jenkins 的安全配置是否正确了。</p>
<p>由于当前项目中还没有 Jenkinsfile 文件，所以触发过后会构建失败，接下来我们直接在代码仓库根目录下面添加 Jenkinsfile 文件，用于描述流水线构建流程，整体实现流程如下图所示：</p>
<p><img alt="Alt Image Text" src="../../images/chp12_2_13.png" title="body image" /></p>
<p>首先定义最简单的流程，要注意这里和前面的不同之处，这里我们使用 podTemplate 来定义不同阶段使用的的容器，有哪些阶段呢？</p>
<pre><code>Clone 代码 -&gt; 单元测试 -&gt; Golang 编译打包 -&gt; Docker 镜像构建/推送 -&gt; Kubectl 部署服务。
</code></pre>
<ul>
<li>
<p>Clone 代码在默认的 Slave 容器中即可；</p>
</li>
<li>
<p>单元测试我们这里直接忽略，有需要这个阶段的同学自己添加上即可；</p>
</li>
<li>
<p>Golang 编译打包肯定就需要 Golang 的容器了；</p>
</li>
<li>
<p>Docker 镜像构建/推送是不是就需要 Docker 环境了；</p>
</li>
<li>
<p>最后的 Kubectl 更新服务是不是就需要一个有 Kubectl 的容器环境了，所以我们这里就可以很简单的定义 <code>podTemplate</code> 了，如下定义：</p>
</li>
</ul>
<pre><code>def label = &quot;slave-${UUID.randomUUID().toString()}&quot;

podTemplate(label: label, containers: [
  containerTemplate(name: 'golang', image: 'golang:1.14.2-alpine3.11', command: 'cat', ttyEnabled: true),
  containerTemplate(name: 'docker', image: 'docker:latest', command: 'cat', ttyEnabled: true),
  containerTemplate(name: 'kubectl', image: 'cnych/kubectl', command: 'cat', ttyEnabled: true)
], serviceAccount: 'jenkins', volumes: [
  hostPathVolume(mountPath: '/home/jenkins/.kube', hostPath: '/root/.kube'),
  hostPathVolume(mountPath: '/var/run/docker.sock', hostPath: '/var/run/docker.sock')
]) {
  node(label) {
    def myRepo = checkout scm
    def gitCommit = myRepo.GIT_COMMIT
    def gitBranch = myRepo.GIT_BRANCH

    stage('单元测试') {
      echo &quot;测试阶段&quot;
    }


    stage('代码编译打包') {
      container('golang') {
        echo &quot;代码编译打包阶段&quot;
      }
    }


    stage('构建 Docker 镜像') {
      container('docker') {
        echo &quot;构建 Docker 镜像阶段&quot;
      }
    }


    stage('运行 Kubectl') {
      container('kubectl') {
        echo &quot;查看 K8S 集群 Pod 列表&quot;
        sh &quot;kubectl get pods&quot;
      }
    }
  }
}
</code></pre>
<p>直接在 <code>podTemplate</code> 里面定义每个阶段需要用到的容器，<code>volumes</code> 里面将我们需要用到的 <code>docker.sock</code>文件，需要注意的我们使用的 label 标签是是一个随机生成的，这样有一个好处就是有多个任务来的时候就可以同时构建了。</p>
<p>正常来说我们还需要将访问集群的 <code>kubeconfig</code> 文件拷贝到 kubectl 容器的 <code>~/.kube/config</code> 文件下面去，这样我们就可以在容器中访问 Kubernetes 集群了，但是由于我们构建是在 <code>Slave Pod</code> 中去构建的，Pod 就很有可能每次调度到不同的节点去，这就需要保证每个节点上有 <code>kubeconfig</code>文件才能挂载成功，所以这里我们使用另外一种方式。</p>
<p>通过将 kubeconfig 文件通过凭证上传到 Jenkins 中，然后在 Jenkinsfile 中读取到这个文件后，拷贝到 kubectl 容器中的 <code>~/.kube/config</code> 文件中，这样同样就可以正常使用 kubectl 访问集群了。在 Jenkins 页面中添加凭据，选择 <code>Secret file</code> 类型，然后上传 <code>kubeconfig</code> 文件，指定 ID 即可：</p>
<p><img alt="Alt Image Text" src="../../images/chp12_2_14.png" title="body image" /></p>
<p>然后在 Jenkinsfile 的 kubectl 容器中读取上面添加的 Secret file 文件，拷贝到 <code>~/.kube/config</code> 即可：</p>
<pre><code>stage('运行 Kubectl') {
  container('kubectl') {
    withCredentials([file(credentialsId: 'kubeconfig', variable: 'KUBECONFIG')]) {
      echo &quot;查看 K8S 集群 Pod 列表&quot;
      sh &quot;mkdir -p ~/.kube &amp;&amp; cp ${KUBECONFIG} ~/.kube/config&quot;
      sh &quot;kubectl get pods&quot;
    }
  }
}
</code></pre>
<p>现在我们直接将 Jenkinsfile 文件提交到 GitLab 代码仓库中，正常来说就可以触发 Jenkins 的构建了：</p>
<pre><code>$ kubectl get pods -n kube-ops
NAME                                                     READY   STATUS              RESTARTS   AGE
jenkins-587b78f5cd-47hf8                                 1/1     Running             2          5d
slave-e3e34e24-721a-4c32-a83e-19033e244b9d-2h6wd-tjkkf   0/4     ContainerCreating   0          38s
</code></pre>
<p>我们可以看到生成的 slave Pod 包含了4个容器，就是我们在 podTemplate 指定的加上 slave 的镜像，运行完成后该 Pod 也会自动销毁。</p>
<p><img alt="Alt Image Text" src="../../images/chp12_2_15.png" title="body image" /></p>
<h3 id="pipeline"><strong>Pipeline</strong></h3>
<p>接下来我们就来实现具体的流水线。</p>
<p>第一个阶段：单元测试，我们可以在这个阶段是运行一些单元测试或者静态代码分析的脚本，我们这里直接忽略。</p>
<p>第二个阶段：代码编译打包，我们可以看到我们是在一个 golang 的容器中来执行的，我们只需要在该容器中获取到代码，然后在代码目录下面执行打包命令即可，如下所示：</p>
<pre><code>
stage('代码编译打包') {
  try {
    container('golang') {
      echo &quot;2.代码编译打包阶段&quot;
      sh &quot;&quot;&quot;
        export GOPROXY=https://goproxy.cn
        GOOS=linux GOARCH=amd64 go build -v -o demo-app
        &quot;&quot;&quot;
    }
  } catch (exc) {
    println &quot;构建失败 - ${currentBuild.fullDisplayName}&quot;
    throw(exc)
  }
</code></pre>
<p>第三个阶段：构建 Docker 镜像，要构建 Docker 镜像，就需要提供镜像的名称和 tag，要推送到 Harbor 仓库，就需要提供登录的用户名和密码，所以我们这里使用到了 <code>withCredentials</code> 方法，在里面可以提供一个<code>credentialsId</code> 为 <code>dockerhub</code> 的认证信息，如下：</p>
<pre><code>stage('构建 Docker 镜像') {
  withCredentials([[$class: 'UsernamePasswordMultiBinding',
    credentialsId: 'docker-auth',
    usernameVariable: 'DOCKER_USER',
    passwordVariable: 'DOCKER_PASSWORD']]) {
      container('docker') {
        echo &quot;3. 构建 Docker 镜像阶段&quot;
        sh &quot;&quot;&quot;
          docker login ${registryUrl} -u ${DOCKER_USER} -p ${DOCKER_PASSWORD}
          docker build -t ${image} .
          docker push ${image}
          &quot;&quot;&quot;
      }
  }
}
</code></pre>
<p>其中 <code>${image}</code>和 <code>${imageTag}</code>我们可以在上面定义成全局变量：</p>
<pre><code>// 获取 git commit id 作为镜像标签
def imageTag = sh(script: &quot;git rev-parse --short HEAD&quot;, returnStdout: true).trim()
// 仓库地址
def registryUrl = &quot;harbor.k8s.local&quot;
def imageEndpoint = &quot;course/devops-demo&quot;
// 镜像
def image = &quot;${registryUrl}/${imageEndpoint}:${imageTag}&quot;
</code></pre>
<p>这里定义的镜像名称为 <code>course/devops-demo</code>，所以需要提前在 Harbor 中新建一个名为 course 的私有项目：</p>
<p><img alt="Alt Image Text" src="../../images/chp12_2_16.png" title="body image" /></p>
<p>Docker 的用户名和密码信息则需要通过凭据来进行添加，进入 <code>jenkins 首页 -&gt; 左侧菜单凭据 -&gt; 添加凭据</code>，选择用户名和密码类型的，其中 ID 一定要和上面的 credentialsId 的值保持一致：</p>
<p><img alt="Alt Image Text" src="../../images/chp12_2_17.png" title="body image" /></p>
<p><strong>不过需要注意的是我们这里使用的是 <code>Docker IN Docke</code>r 模式来构建 Docker 镜像，通过将宿主机的 <code>docker.sock</code> 文件挂载到容器中来共享 <code>Docker Daemon</code>，所以我们也需要提前在节点上配置对 Harbor 镜像仓库的信任:</strong></p>
<pre><code>$ vi /etc/docker/daemon.json
{
  &quot;insecure-registries&quot; : [  # 配置忽略 Harobr 镜像仓库的证书校验
    &quot;harbor.k8s.local&quot;
  ],
  &quot;storage-driver&quot;: &quot;overlay2&quot;,
  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],
  &quot;registry-mirrors&quot; : [
    &quot;https://ot2k4d59.mirror.aliyuncs.com/&quot;
  ],
}

$ systemctl daemon-reload
$ systemctl restart docker
</code></pre>
<p>配置生效过后我们就可以正常在流水线中去操作 Docker 命令，否则会出现如下所示的错误：</p>
<p><img alt="Alt Image Text" src="../../images/chp12_2_18.png" title="body image" /></p>
<p>现在镜像我们都已经推送到了 Harbor 仓库中去了，接下来就可以部署应用到 Kubernetes 集群中了，当然可以直接通过 kubectl 工具去操作 YAML 文件来部署，我们这里的示例，编写了一个 Helm Chart 模板，所以我们也可以直接通过 Helm 来进行部署，所以当然就需要一个具有 helm 命令的容器，这里我们使用 <code>cnych/helm</code> 这个镜像，这个镜像也非常简单，就是简单的将 helm 二进制文件下载下来放到 PATH 路径下面去即可，对应的 Dockerfile 文件如下所示，大家也可以根据自己的需要来进行定制：</p>
<pre><code>FROM alpine
MAINTAINER cnych &lt;icnych@gmail.com&gt;
ARG HELM_VERSION=&quot;v3.2.1&quot;
RUN apk add --update ca-certificates \
 &amp;&amp; apk add --update -t deps wget git openssl bash \
 &amp;&amp; wget https://get.helm.sh/helm-${HELM_VERSION}-linux-amd64.tar.gz \
 &amp;&amp; tar -xvf helm-${HELM_VERSION}-linux-amd64.tar.gz \
 &amp;&amp; mv linux-amd64/helm /usr/local/bin \
 &amp;&amp; apk del --purge deps \
 &amp;&amp; rm /var/cache/apk/* \
 &amp;&amp; rm -f /helm-${HELM_VERSION}-linux-amd64.tar.gz
ENTRYPOINT [&quot;helm&quot;]
CMD [&quot;help&quot;]
</code></pre>
<p>我们这里使用的是 Helm3 版本，所以要想用 Helm 来部署应用，同样的需要配置一个 kubeconfig 文件在容器中，这样才能访问到 Kubernetes 集群。所以我们可以将 运行 Kubectl 的阶段做如下更改：</p>
<pre><code>stage('运行 Helm') {
  withCredentials([file(credentialsId: 'kubeconfig', variable: 'KUBECONFIG')]) {
    container('helm') {
      sh &quot;mkdir -p ~/.kube &amp;&amp; cp ${KUBECONFIG} ~/.kube/config&quot;
      echo &quot;4.开始 Helm 部署&quot;
      helmDeploy(
          debug       : false,
          name        : &quot;devops-demo&quot;,
          chartDir    : &quot;./helm&quot;,
          namespace   : &quot;kube-ops&quot;,
          valuePath   : &quot;./helm/my-value.yaml&quot;,
          imageTag    : &quot;${imageTag}&quot;
      )
      echo &quot;[INFO] Helm 部署应用成功...&quot;
    }
  }
</code></pre>
<p>其中 <code>helmDeploy</code>方法可以在全局中进行定义封装：</p>
<pre><code>def helmLint(String chartDir) {
    println &quot;校验 chart 模板&quot;
    sh &quot;helm lint ${chartDir}&quot;
}

def helmDeploy(Map args) {
    if (args.debug) {
        println &quot;Debug 应用&quot;
        sh &quot;helm upgrade --dry-run --debug --install ${args.name} ${args.chartDir} -f ${args.valuePath} --set image.tag=${args.imageTag} --namespace ${args.namespace}&quot;
    } else {
        println &quot;部署应用&quot;
        sh &quot;helm upgrade --install ${args.name} ${args.chartDir} -f ${args.valuePath} --set image.tag=${args.imageTag} --namespace ${args.namespace}&quot;
        echo &quot;应用 ${args.name} 部署成功. 可以使用 helm status ${args.name} 查看应用状态&quot;
    }
}
</code></pre>
<p><strong>我们在 Chart 模板中定义了一个名为 <code>my-values.yaml</code> 的 <code>Values</code> 文件，用来覆盖默认的值，比如这里我们需要使用 Harbor 私有仓库的镜像，则必然需要定义 <code>imagePullSecrets</code>，所以需要在目标 <code>namespace</code> 下面创建一个 <code>Harbor</code>登录认证的 <code>Secret</code>对象</strong>：</p>
<pre><code>$ kubectl create secret docker-registry harbor-auth --docker-server=harbor.k8s.local --docker-username=admin --docker-password=Harbor12345 --docker-email=admin@admin.com --namespace kube-ops
secret/harbor-auth created
</code></pre>
<p>然后由于每次我们构建的镜像 tag 都会变化，所以我们可以通过 <code>--set</code> 来动态设置。</p>
<p>不过需要记得在上面容器模板中添加 helm 容器：</p>
<pre><code>containerTemplate(name: 'helm', image: 'cnych/helm', command: 'cat', ttyEnabled: true)
</code></pre>
<p>对于不同的环境我们可以使用不同的 values 文件来进行区分，这样当我们部署的时候可以手动选择部署到某个环境下面去。</p>
<pre><code>
def userInput = input(
  id: 'userInput',
  message: '选择一个部署环境',
  parameters: [
      [
          $class: 'ChoiceParameterDefinition',
          choices: &quot;Dev\nQA\nProd&quot;,
          name: 'Env'
      ]
  ]
)
echo &quot;部署应用到 ${userInput} 环境&quot;
// 选择不同环境下面的 values 文件
if (userInput == &quot;Dev&quot;) {
    // deploy dev stuff
} else if (userInput == &quot;QA&quot;){
    // deploy qa stuff
} else {
    // deploy prod stuff
}
// 根据 values 文件再去使用 Helm 进行部署
</code></pre>
<p>然后去构建应用的时候，在 Helm 部署阶段就会看到 Stage View 界面出现了暂停的情况，需要我们选择一个环境来进行部署：</p>
<p><img alt="Alt Image Text" src="../../images/chp12_2_19.png" title="body image" /></p>
<p>选择完成后再去部署应用。最后我们还可以添加一个 kubectl 容器来查看应用的相关资源对象：</p>
<pre><code>stage('运行 Kubectl') {
  withCredentials([file(credentialsId: 'kubeconfig', variable: 'KUBECONFIG')]) {
    container('kubectl') {
      sh &quot;mkdir -p ~/.kube &amp;&amp; cp ${KUBECONFIG} ~/.kube/config&quot;
      echo &quot;5.查看应用&quot;
      sh &quot;kubectl get all -n kube-ops -l app=devops-demo&quot;
    }
  }
}
</code></pre>
<p>有时候我们部署的应用即使有很多测试，但是也难免会出现一些错误，这个时候如果我们是部署到线上的话，就需要要求能够立即进行回滚，这里我们同样可以使用 Helm 来非常方便的操作，添加如下一个回滚的阶段：</p>
<pre><code>stage('快速回滚?') {
  withCredentials([file(credentialsId: 'kubeconfig', variable: 'KUBECONFIG')]) {
    container('helm') {
      sh &quot;mkdir -p ~/.kube &amp;&amp; cp ${KUBECONFIG} ~/.kube/config&quot;
      def userInput = input(
        id: 'userInput',
        message: '是否需要快速回滚？',
        parameters: [
            [
                $class: 'ChoiceParameterDefinition',
                choices: &quot;Y\nN&quot;,
                name: '回滚?'
            ]
        ]
      )
      if (userInput == &quot;Y&quot;) {
        sh &quot;helm rollback devops-demo --namespace kube-ops&quot;
      }
    }
  }
}
</code></pre>
<p>最后一条完整的流水线就完成了。</p>
<p><img alt="Alt Image Text" src="../../images/chp12_2_20.png" title="body image" /></p>
<p>我们可以在本地加上应用域名 <code>devops-demo.k8s.local</code> 的映射就可以访问应用了：</p>
<pre><code>$ curl http://devops-demo.k8s.local
{&quot;msg&quot;:&quot;Hello DevOps On Kubernetes&quot;}
</code></pre>
<p>完整的 Jenkinsfile 文件如下所示：</p>
<pre><code>def label = &quot;slave-${UUID.randomUUID().toString()}&quot;

def helmLint(String chartDir) {
    println &quot;校验 chart 模板&quot;
    sh &quot;helm lint ${chartDir}&quot;
}

def helmDeploy(Map args) {
    if (args.debug) {
        println &quot;Debug 应用&quot;
        sh &quot;helm upgrade --dry-run --debug --install ${args.name} ${args.chartDir} -f ${args.valuePath} --set image.tag=${args.imageTag} --namespace ${args.namespace}&quot;
    } else {
        println &quot;部署应用&quot;
        sh &quot;helm upgrade --install ${args.name} ${args.chartDir} -f ${args.valuePath} --set image.tag=${args.imageTag} --namespace ${args.namespace}&quot;
        echo &quot;应用 ${args.name} 部署成功. 可以使用 helm status ${args.name} 查看应用状态&quot;
    }
}

podTemplate(label: label, containers: [
  containerTemplate(name: 'golang', image: 'golang:1.14.2-alpine3.11', command: 'cat', ttyEnabled: true),
  containerTemplate(name: 'docker', image: 'docker:latest', command: 'cat', ttyEnabled: true),
  containerTemplate(name: 'helm', image: 'cnych/helm', command: 'cat', ttyEnabled: true),
  containerTemplate(name: 'kubectl', image: 'cnych/kubectl', command: 'cat', ttyEnabled: true)
], serviceAccount: 'jenkins', volumes: [
  hostPathVolume(mountPath: '/var/run/docker.sock', hostPath: '/var/run/docker.sock')
]) {
  node(label) {
    def myRepo = checkout scm
    // 获取 git commit id 作为镜像标签
    def imageTag = sh(script: &quot;git rev-parse --short HEAD&quot;, returnStdout: true).trim()
    // 仓库地址
    def registryUrl = &quot;harbor.k8s.local&quot;
    def imageEndpoint = &quot;course/devops-demo&quot;
    // 镜像
    def image = &quot;${registryUrl}/${imageEndpoint}:${imageTag}&quot;

    stage('单元测试') {
      echo &quot;测试阶段&quot;
    }
    stage('代码编译打包') {
      try {
        container('golang') {
          echo &quot;2.代码编译打包阶段&quot;
          sh &quot;&quot;&quot;
            export GOPROXY=https://goproxy.cn
            GOOS=linux GOARCH=amd64 go build -v -o demo-app
            &quot;&quot;&quot;
        }
      } catch (exc) {
        println &quot;构建失败 - ${currentBuild.fullDisplayName}&quot;
        throw(exc)
      }
    }
    stage('构建 Docker 镜像') {
      withCredentials([[$class: 'UsernamePasswordMultiBinding',
        credentialsId: 'docker-auth',
        usernameVariable: 'DOCKER_USER',
        passwordVariable: 'DOCKER_PASSWORD']]) {
          container('docker') {
            echo &quot;3. 构建 Docker 镜像阶段&quot;
            sh &quot;&quot;&quot;
              cat /etc/resolv.conf
              docker login ${registryUrl} -u ${DOCKER_USER} -p ${DOCKER_PASSWORD}
              docker build -t ${image} .
              docker push ${image}
              &quot;&quot;&quot;
          }
      }
    }
    stage('运行 Helm') {
      withCredentials([file(credentialsId: 'kubeconfig', variable: 'KUBECONFIG')]) {
        container('helm') {
          sh &quot;mkdir -p ~/.kube &amp;&amp; cp ${KUBECONFIG} ~/.kube/config&quot;
          echo &quot;4.开始 Helm 部署&quot;
          def userInput = input(
            id: 'userInput',
            message: '选择一个部署环境',
            parameters: [
                [
                    $class: 'ChoiceParameterDefinition',
                    choices: &quot;Dev\nQA\nProd&quot;,
                    name: 'Env'
                ]
            ]
          )
          echo &quot;部署应用到 ${userInput} 环境&quot;
          // 选择不同环境下面的 values 文件
          if (userInput == &quot;Dev&quot;) {
              // deploy dev stuff
          } else if (userInput == &quot;QA&quot;){
              // deploy qa stuff
          } else {
              // deploy prod stuff
          }
          helmDeploy(
              debug       : false,
              name        : &quot;devops-demo&quot;,
              chartDir    : &quot;./helm&quot;,
              namespace   : &quot;kube-ops&quot;,
              valuePath   : &quot;./helm/my-values.yaml&quot;,
              imageTag    : &quot;${imageTag}&quot;
          )
        }
      }
    }
    stage('运行 Kubectl') {
      withCredentials([file(credentialsId: 'kubeconfig', variable: 'KUBECONFIG')]) {
        container('kubectl') {
          sh &quot;mkdir -p ~/.kube &amp;&amp; cp ${KUBECONFIG} ~/.kube/config&quot;
          echo &quot;5.查看应用&quot;
          sh &quot;kubectl get all -n kube-ops -l app=devops-demo&quot;
        }
      }
    }
    stage('快速回滚?') {
      withCredentials([file(credentialsId: 'kubeconfig', variable: 'KUBECONFIG')]) {
        container('helm') {
          sh &quot;mkdir -p ~/.kube &amp;&amp; cp ${KUBECONFIG} ~/.kube/config&quot;
          def userInput = input(
            id: 'userInput',
            message: '是否需要快速回滚？',
            parameters: [
                [
                    $class: 'ChoiceParameterDefinition',
                    choices: &quot;Y\nN&quot;,
                    name: '回滚?'
                ]
            ]
          )
          if (userInput == &quot;Y&quot;) {
            sh &quot;helm rollback devops-demo --namespace kube-ops&quot;
          }
        }
      }
    }
  }
}
</code></pre>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2016-2020 Jacob Xi
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.b425cdc4.min.js"></script>
      
    
  </body>
</html>